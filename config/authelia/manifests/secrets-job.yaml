apiVersion: v1
kind: ServiceAccount
metadata:
  name: authelia-secret-generator
  namespace: authelia
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: authelia-secret-generator
  namespace: authelia
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "create"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: authelia-secret-generator
  namespace: authelia
subjects:
  - kind: ServiceAccount
    name: authelia-secret-generator
    namespace: authelia
roleRef:
  kind: Role
  name: authelia-secret-generator
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: batch/v1
kind: Job
metadata:
  name: authelia-generate-secrets
  namespace: authelia
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  template:
    spec:
      serviceAccountName: authelia-secret-generator
      restartPolicy: OnFailure
      containers:
        - name: generate
          image: ghcr.io/authelia/authelia:latest
          command:
            - /bin/sh
            - -c
            - |
              set -e
              
              # Install kubectl
              wget -q -O /tmp/kubectl "https://dl.k8s.io/release/v1.31.0/bin/linux/amd64/kubectl"
              chmod +x /tmp/kubectl
              
              # Check if secret already exists
              if /tmp/kubectl get secret authelia-secrets -n authelia 2>/dev/null; then
                echo "Secret already exists, skipping generation"
                exit 0
              fi
              
              echo "Generating Authelia secrets..."
              
              JWT_SECRET=$(openssl rand -base64 32)
              SESSION_SECRET=$(openssl rand -base64 32)
              STORAGE_ENCRYPTION_KEY=$(openssl rand -base64 32)
              
              # Generate secure random password (20 chars alphanumeric)
              ADMIN_PASSWORD=$(openssl rand -base64 24 | tr -dc 'a-zA-Z0-9' | head -c 20)
              
              # Use Authelia's built-in hash command
              PASSWORD_HASH=$(authelia crypto hash generate argon2 --password "$ADMIN_PASSWORD" 2>/dev/null | grep 'Digest:' | cut -d' ' -f2)
              
              cat > /tmp/users.yaml << EOF
              users:
                admin:
                  displayname: Admin
                  email: admin@newjoy.ro
                  password: $PASSWORD_HASH
                  groups:
                    - admins
              EOF
              
              /tmp/kubectl create secret generic authelia-secrets \
                --namespace=authelia \
                --from-literal=JWT_SECRET="$JWT_SECRET" \
                --from-literal=SESSION_SECRET="$SESSION_SECRET" \
                --from-literal=STORAGE_ENCRYPTION_KEY="$STORAGE_ENCRYPTION_KEY" \
                --from-literal=ADMIN_PASSWORD="$ADMIN_PASSWORD" \
                --from-file=users.yaml=/tmp/users.yaml
              
              echo ""
              echo "=== Secrets created successfully! ==="
              echo "Retrieve admin password with:"
              echo "  kubectl get secret authelia-secrets -n authelia -o jsonpath='{.data.ADMIN_PASSWORD}' | base64 -d"

