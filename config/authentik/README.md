# Authentik - Identity Provider

Authentik provides SSO, OIDC, and application proxy for the homelab.

## Secrets

Secrets are auto-generated by a Kubernetes Job on first deployment:
- `secret_key` - Used for signing sessions/cookies
- `postgres_password` - PostgreSQL database password

The Job only creates the secret if it doesn't exist, so persistent storage works correctly.

To regenerate secrets (will break existing sessions):
```bash
kubectl delete secret authentik-secrets -n authentik
# Then resync the app
```

## Disaster Recovery

When restoring from Longhorn backup:

1. **Restore the PVC** (PostgreSQL data)
2. **Restore the secret** - The Job will fail if PVC exists but secret is missing

To backup the secret:
```bash
kubectl get secret authentik-secrets -n authentik -o yaml > authentik-secrets-backup.yaml
```

To restore the secret:
```bash
kubectl apply -f authentik-secrets-backup.yaml
```

If starting completely fresh (no data to preserve):
```bash
kubectl delete pvc -n authentik -l app.kubernetes.io/name=postgresql
kubectl delete secret authentik-secrets -n authentik
# Then resync - new secrets will be generated
```

## Architecture

```
User → Cloudflare → nginx-ingress → Authentik
                                        │
                    ┌───────────────────┼───────────────────┐
                    ▼                   ▼                   ▼
              Embedded Proxy       OIDC Apps            Dashboard
              (apps w/o auth)    (ArgoCD, etc.)      (app launcher)
```

## Access

- **URL:** https://auth.newjoy.ro
- **Initial Setup:** First user to access becomes admin

## First Time Setup

1. Get the admin password:
   ```bash
   kubectl get secret authentik-secrets -n authentik -o jsonpath='{.data.bootstrap_password}' | base64 -d
   ```

2. Login at https://auth.newjoy.ro
   - Username: `akadmin`
   - Password: (from step 1)

3. Change your password after first login

## Protecting Apps Without Auth (Proxy Mode)

Apps like Longhorn are protected via **Blueprints** (GitOps managed).
Authentik acts as a reverse proxy - handling both authentication AND proxying to the backend.

```
User → nginx-ingress → Authentik Outpost → Backend App
```

### Adding a New Protected App

1. Add a blueprint entry to `manifests/blueprints-configmap.yaml`
2. Create an ingress that routes to `authentik-server:9000` in the `authentik` namespace
3. Commit and sync

### Blueprint Example (in blueprints-configmap.yaml)

```yaml
# Proxy Provider - Authentik proxies traffic after auth
- model: authentik_providers_proxy.proxyprovider
  id: myapp-provider
  state: present
  attrs:
    name: myapp-proxy
    authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
    mode: proxy
    external_host: https://myapp.newjoy.ro
    internal_host: http://myapp-service.myapp-namespace.svc.cluster.local:80

# Application
- model: authentik_core.application
  id: myapp-app
  state: present
  attrs:
    name: My App
    slug: myapp
    provider: !KeyOf myapp-provider
    meta_launch_url: https://myapp.newjoy.ro

# Add provider to embedded outpost
- model: authentik_outposts.outpost
  id: embedded-outpost
  state: present
  attrs:
    name: authentik Embedded Outpost
    type: proxy
    providers:
      - !KeyOf myapp-provider
```

### Ingress (points to Authentik, not the app)
```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: myapp
  namespace: authentik  # Must be in authentik namespace
spec:
  ingressClassName: nginx
  rules:
    - host: myapp.newjoy.ro
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: authentik-server
                port:
                  number: 9000
```

## Apps With OIDC Support

For apps like ArgoCD that support OIDC:

1. In Authentik Admin → Applications → Create
2. Create an "OAuth2/OpenID Provider"
3. Configure the app to use Authentik as OIDC provider

## Components

| Component | Purpose | Storage |
|-----------|---------|---------|
| Server | Main application | None |
| Worker | Background tasks | None |
| PostgreSQL | Database | 2Gi SSD |
| Redis | Cache/Sessions | 1Gi SSD |

## Troubleshooting

```bash
# Check pods
kubectl get pods -n authentik

# Server logs
kubectl logs -n authentik -l app.kubernetes.io/name=authentik,app.kubernetes.io/component=server

# Worker logs
kubectl logs -n authentik -l app.kubernetes.io/name=authentik,app.kubernetes.io/component=worker
```

