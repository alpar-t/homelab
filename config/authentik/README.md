# Authentik - Identity Provider

Authentik provides SSO, OIDC, and application proxy for the homelab.

## Secrets

Secrets are auto-generated by a Kubernetes Job on first deployment:
- `secret_key` - Used for signing sessions/cookies
- `postgres_password` - PostgreSQL database password

The Job only creates the secret if it doesn't exist, so persistent storage works correctly.

To regenerate secrets (will break existing sessions):
```bash
kubectl delete secret authentik-secrets -n authentik
# Then resync the app
```

## Disaster Recovery

When restoring from Longhorn backup:

1. **Restore the PVC** (PostgreSQL data)
2. **Restore the secret** - The Job will fail if PVC exists but secret is missing

To backup the secret:
```bash
kubectl get secret authentik-secrets -n authentik -o yaml > authentik-secrets-backup.yaml
```

To restore the secret:
```bash
kubectl apply -f authentik-secrets-backup.yaml
```

If starting completely fresh (no data to preserve):
```bash
kubectl delete pvc -n authentik -l app.kubernetes.io/name=postgresql
kubectl delete secret authentik-secrets -n authentik
# Then resync - new secrets will be generated
```

## Architecture

```
User → Cloudflare → nginx-ingress → Authentik
                                        │
                    ┌───────────────────┼───────────────────┐
                    ▼                   ▼                   ▼
              Embedded Proxy       OIDC Apps            Dashboard
              (apps w/o auth)    (ArgoCD, etc.)      (app launcher)
```

## Access

- **URL:** https://auth.newjoy.ro
- **Initial Setup:** First user to access becomes admin

## First Time Setup

1. Get the admin password:
   ```bash
   kubectl get secret authentik-secrets -n authentik -o jsonpath='{.data.bootstrap_password}' | base64 -d
   ```

2. Login at https://auth.newjoy.ro
   - Username: `akadmin`
   - Password: (from step 1)

3. Change your password after first login

## Protecting Apps Without Auth (Proxy Mode)

Authentik can protect apps that have no built-in authentication by acting as a reverse proxy.

```
User → nginx-ingress → Authentik Outpost → Backend App
```

### Adding a New Protected App

**1. Create the ingress (GitOps)**

Add an ingress that routes to Authentik's embedded outpost:

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: myapp
  namespace: authentik  # Must be in authentik namespace
spec:
  ingressClassName: nginx
  rules:
    - host: myapp.newjoy.ro
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: authentik-server
                port:
                  number: 9000
```

**2. Configure in Authentik UI**

1. **Create Provider**: Applications → Providers → Create → Proxy Provider
   - Name: `myapp-proxy`
   - Mode: **Proxy**
   - External host: `https://myapp.newjoy.ro`
   - Internal host: `http://myapp-service.myapp-namespace.svc.cluster.local:80`

2. **Create Application**: Applications → Applications → Create
   - Name: `My App`
   - Slug: `myapp`
   - Provider: select `myapp-proxy`

3. **Add to Outpost**: Applications → Outposts → authentik Embedded Outpost
   - Add `My App` to Applications
   - Update

See `config/longhorn/README.md` for a complete example

## Apps With OIDC Support

For apps like ArgoCD that support OIDC:

1. In Authentik Admin → Applications → Create
2. Create an "OAuth2/OpenID Provider"
3. Configure the app to use Authentik as OIDC provider

## Components

| Component | Purpose | Storage |
|-----------|---------|---------|
| Server | Main application | None |
| Worker | Background tasks | None |
| PostgreSQL | Database | 2Gi SSD |
| Redis | Cache/Sessions | 1Gi SSD |

## Troubleshooting

```bash
# Check pods
kubectl get pods -n authentik

# Server logs
kubectl logs -n authentik -l app.kubernetes.io/name=authentik,app.kubernetes.io/component=server

# Worker logs
kubectl logs -n authentik -l app.kubernetes.io/name=authentik,app.kubernetes.io/component=worker
```

