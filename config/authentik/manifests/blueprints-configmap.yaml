apiVersion: v1
kind: ConfigMap
metadata:
  name: authentik-blueprints
  namespace: authentik
data:
  longhorn.yaml: |
    # Blueprint for Longhorn proxy protection
    # Authentik proxies traffic to Longhorn (no auth annotations needed on ingress)
    version: 1
    metadata:
      name: Longhorn Protection
      labels:
        blueprints.goauthentik.io/instantiate: "true"
    entries:
      # Proxy Provider for Longhorn
      - model: authentik_providers_proxy.proxyprovider
        id: longhorn-provider
        identifiers:
          name: longhorn-proxy
        state: present
        attrs:
          name: longhorn-proxy
          authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
          mode: proxy
          external_host: https://longhorn.newjoy.ro
          internal_host: http://longhorn-frontend.longhorn-system.svc.cluster.local:80
      
      # Application for Longhorn
      - model: authentik_core.application
        id: longhorn-app
        identifiers:
          slug: longhorn
        state: present
        attrs:
          name: Longhorn
          slug: longhorn
          provider: !KeyOf longhorn-provider
          meta_launch_url: https://longhorn.newjoy.ro
          meta_icon: https://longhorn.io/img/logos/longhorn-icon-white.png
          meta_description: Distributed storage for Kubernetes
          policy_engine_mode: any
      
      # Update embedded outpost to include our provider
      - model: authentik_outposts.outpost
        identifiers:
          name: authentik Embedded Outpost
        state: present
        attrs:
          type: proxy
          providers:
            - !KeyOf longhorn-provider

