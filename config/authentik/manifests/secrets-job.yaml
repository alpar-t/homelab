apiVersion: v1
kind: ServiceAccount
metadata:
  name: authentik-secrets-generator
  namespace: authentik
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: authentik-secrets-generator
  namespace: authentik
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "create"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: authentik-secrets-generator
  namespace: authentik
subjects:
  - kind: ServiceAccount
    name: authentik-secrets-generator
    namespace: authentik
roleRef:
  kind: Role
  name: authentik-secrets-generator
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: batch/v1
kind: Job
metadata:
  name: authentik-secrets-generator
  namespace: authentik
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  template:
    spec:
      serviceAccountName: authentik-secrets-generator
      restartPolicy: OnFailure
      containers:
        - name: generate-secrets
          image: bitnami/kubectl:latest
          command:
            - /bin/bash
            - -c
            - |
              set -e
              
              # Check if secret already exists
              if kubectl get secret authentik-secrets -n authentik >/dev/null 2>&1; then
                echo "Secret 'authentik-secrets' already exists, skipping generation"
                exit 0
              fi
              
              # Check if PostgreSQL PVC exists with data (disaster recovery scenario)
              # If PV is restored but secret is missing, we can't regenerate - need manual intervention
              if kubectl get pvc -n authentik -l app.kubernetes.io/name=postgresql 2>/dev/null | grep -q Bound; then
                echo "ERROR: PostgreSQL PVC exists but secret is missing!"
                echo "This likely means you restored from backup but forgot to restore the secret."
                echo ""
                echo "To fix, restore the secret from your backup, or if starting fresh:"
                echo "  kubectl delete pvc -n authentik -l app.kubernetes.io/name=postgresql"
                echo "Then re-run this job."
                exit 1
              fi
              
              echo "Generating Authentik secrets..."
              
              # Generate random values
              SECRET_KEY=$(head -c 50 /dev/urandom | base64 | tr -dc 'a-zA-Z0-9' | head -c 50)
              POSTGRES_PASSWORD=$(head -c 32 /dev/urandom | base64 | tr -dc 'a-zA-Z0-9' | head -c 32)
              BOOTSTRAP_PASSWORD=$(head -c 24 /dev/urandom | base64 | tr -dc 'a-zA-Z0-9' | head -c 24)
              
              # Create the secret
              kubectl create secret generic authentik-secrets \
                --namespace=authentik \
                --from-literal=secret_key="$SECRET_KEY" \
                --from-literal=postgres_password="$POSTGRES_PASSWORD" \
                --from-literal=bootstrap_password="$BOOTSTRAP_PASSWORD"
              
              echo ""
              echo "=== IMPORTANT: Save this admin password ==="
              echo "Username: akadmin"
              echo "Password: $BOOTSTRAP_PASSWORD"
              echo "==========================================="
              
              echo "Secret 'authentik-secrets' created successfully"

