# Authentik Configuration for homelab
# Docs: https://docs.goauthentik.io/docs/install-config/install/kubernetes

global:
  # Environment variables for secret references
  env:
    - name: AUTHENTIK_SECRET_KEY
      valueFrom:
        secretKeyRef:
          name: authentik-secrets
          key: secret_key
    - name: AUTHENTIK_POSTGRESQL__PASSWORD
      valueFrom:
        secretKeyRef:
          name: authentik-secrets
          key: postgres_password
    # Bootstrap admin credentials
    - name: AUTHENTIK_BOOTSTRAP_PASSWORD
      valueFrom:
        secretKeyRef:
          name: authentik-secrets
          key: bootstrap_password
    - name: AUTHENTIK_BOOTSTRAP_EMAIL
      value: "admin@newjoy.ro"

  # HA: Spread pods across nodes
  affinity:
    podAntiAffinity: soft

# Load blueprints from ConfigMap (GitOps managed)
blueprints:
  configMaps:
    - authentik-blueprints

authentik:
  # Log level
  log_level: info
  
  # Error reporting (disabled for privacy)
  error_reporting:
    enabled: false
  
  # PostgreSQL connection (uses bundled PostgreSQL)
  postgresql:
    host: "{{ .Release.Name }}-postgresql"
    name: "authentik"
    user: "authentik"
    # Password set via AUTHENTIK_POSTGRESQL__PASSWORD env var

server:
  # HA: Run on multiple nodes
  replicas: 2
  
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
  
  ingress:
    enabled: true
    ingressClassName: nginx
    hosts:
      - auth.newjoy.ro
    # TLS handled by Cloudflare
    tls: []

worker:
  # HA: Run on multiple nodes
  replicas: 2
  
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

# Bundled PostgreSQL
# Note: Single replica with Longhorn replication provides data redundancy.
# For true HA PostgreSQL, consider CloudNativePG operator in the future.
postgresql:
  enabled: true
  auth:
    username: authentik
    database: authentik
    # Password from generated secret
    existingSecret: authentik-secrets
    secretKeys:
      adminPasswordKey: postgres_password
      userPasswordKey: postgres_password
  primary:
    persistence:
      enabled: true
      storageClass: longhorn-ssd
      size: 2Gi
    resources:
      requests:
        cpu: 50m
        memory: 128Mi
      limits:
        cpu: 200m
        memory: 256Mi

# Bundled Redis
# Note: Standalone is sufficient - Longhorn handles data redundancy.
# For true HA Redis, enable sentinel architecture.
redis:
  enabled: true
  architecture: standalone
  auth:
    enabled: false
  master:
    persistence:
      enabled: true
      storageClass: longhorn-ssd
      size: 1Gi
    resources:
      requests:
        cpu: 25m
        memory: 64Mi
      limits:
        cpu: 100m
        memory: 128Mi
