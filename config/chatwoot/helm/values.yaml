# Chatwoot Helm Chart Values
# https://github.com/chatwoot/charts
#
# Prerequisites:
#   1. chatwoot-secrets secret (auto-generated by job)
#   2. chatwoot-config secret (MAILER_SENDER_EMAIL)
#   3. cnpg-backup-credentials secret (for PostgreSQL backups)
#   4. oauth2-proxy-chatwoot secret (for OAuth2 proxy)

image:
  repository: chatwoot/chatwoot
  tag: v4.10.0
  pullPolicy: IfNotPresent

# Use external PostgreSQL (CloudNativePG)
postgresql:
  enabled: false

# Use external Redis (our own deployment)
redis:
  enabled: false

# Static environment variables
env:
  # Rails environment
  RAILS_ENV: "production"
  RAILS_LOG_TO_STDOUT: "true"
  LOG_LEVEL: "info"
  
  # Frontend URL (what users see in browser)
  FRONTEND_URL: "https://chat.newjoy.ro"
  
  # FORCE_SSL should be false when behind Cloudflare/reverse proxy
  # TLS terminates at Cloudflare edge, nginx handles the rest
  FORCE_SSL: "false"
  
  # Disable signup (single user via OAuth)
  ENABLE_ACCOUNT_SIGNUP: "false"
  
  # Installation identifier
  INSTALLATION_ENV: "helm"
  
  # Storage - use local filesystem
  ACTIVE_STORAGE_SERVICE: "local"
  
  # SMTP configuration via Stalwart
  SMTP_ADDRESS: "stalwart.stalwart-mail.svc.cluster.local"
  SMTP_PORT: "25"
  SMTP_AUTHENTICATION: "none"
  SMTP_ENABLE_STARTTLS_AUTO: "false"
  SMTP_OPENSSL_VERIFY_MODE: "none"
  
  # Redis configuration (our own Redis)
  REDIS_URL: "redis://redis.chatwoot.svc.cluster.local:6379"
  
  # Bot avatar
  USE_INBOX_AVATAR_FOR_BOT: "true"

# Environment variables from secrets (references, not copies)
extraEnvVars:
  # Database URL from CloudNativePG auto-generated secret
  - name: DATABASE_URL
    valueFrom:
      secretKeyRef:
        name: chatwoot-db-app
        key: uri
  # SECRET_KEY_BASE from auto-generated secret
  - name: SECRET_KEY_BASE
    valueFrom:
      secretKeyRef:
        name: chatwoot-secrets
        key: SECRET_KEY_BASE
  # MAILER_SENDER_EMAIL from config secret
  - name: MAILER_SENDER_EMAIL
    valueFrom:
      secretKeyRef:
        name: chatwoot-config
        key: MAILER_SENDER_EMAIL

# Web deployment
web:
  replicaCount: 1
  resources:
    requests:
      cpu: 100m
      memory: 512Mi
    limits:
      cpu: 1000m
      memory: 1Gi

# Worker deployment
worker:
  replicaCount: 1
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

# Persistence for file uploads
persistence:
  enabled: true
  existingClaim: chatwoot-storage

# Service configuration
service:
  type: ClusterIP
  port: 3000

# Ingress is handled by oauth2-proxy, not directly
ingress:
  enabled: false

# Pod annotations for secret reloading
podAnnotations:
  reloader.stakater.com/auto: "true"

# Liveness and readiness probes
livenessProbe:
  httpGet:
    path: /api
    port: 3000
  initialDelaySeconds: 60
  periodSeconds: 30
  timeoutSeconds: 10

readinessProbe:
  httpGet:
    path: /api
    port: 3000
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5

