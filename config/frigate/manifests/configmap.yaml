# Frigate configuration
# NVR with motion detection for 3x 4K cameras
# Gate camera has LPR enabled for license plate recognition

apiVersion: v1
kind: ConfigMap
metadata:
  name: frigate-config
  namespace: frigate
  labels:
    app.kubernetes.io/name: frigate
data:
  config.yml: |
    # Frigate NVR Configuration
    # https://docs.frigate.video/configuration/

    mqtt:
      enabled: true
      host: "{FRIGATE_MQTT_HOST}"
      port: 1883
      user: "{FRIGATE_MQTT_USER}"
      password: "{FRIGATE_MQTT_PASSWORD}"
      client_id: frigate
      topic_prefix: frigate

    # Intel VAAPI hardware acceleration
    ffmpeg:
      hwaccel_args: preset-vaapi

    # License Plate Recognition (LPR)
    # https://docs.frigate.video/configuration/license_plate_recognition/
    lpr:
      enabled: true
      detection_threshold: 0.6
      recognition_threshold: 0.85
      min_area: 500
      device: CPU
      known_plates:
        "Family":
          - "CJ48TAK"
          - "CJ29SGU"
          - "CJ29UKC"

    # Notifications for license plate recognition
    # Sends all recognized plates via MQTT
    notifications:
      enabled: true
      email:
        enabled: false

    # Recording configuration
    record:
      enabled: true
      retain:
        days: 7
        mode: motion
      alerts:
        retain:
          days: 14
      detections:
        retain:
          days: 14

    # Snapshots on motion
    snapshots:
      enabled: true
      retain:
        default: 14

    # Camera definitions
    cameras:
      front:
        enabled: true
        detect:
          enabled: false
          width: 640
          height: 360
          fps: 12
        lpr:
          enabled: false
        motion:
          # Disable contrast enhancement to avoid CPU-based gamma filter
          improve_contrast: false
        ffmpeg:
          inputs:
            - path: rtsp://admin:{FRIGATE_RTSP_PASSWORD}@192.168.1.20:554/ch1/main/av_stream
              roles:
                - record
            - path: rtsp://admin:{FRIGATE_RTSP_PASSWORD}@192.168.1.20:554/ch1/sub/av_stream
              roles:
                - detect

      gate:
        enabled: true
        detect:
          # Enable detection for LPR to work
          enabled: true
          width: 640
          height: 360
          fps: 12
        objects:
          track:
            - car
            - motorcycle
          filters:
            car:
              # Lower threshold to catch cars at distance
              min_score: 0.5
              threshold: 0.65
            motorcycle:
              min_score: 0.5
              threshold: 0.65
        lpr:
          enabled: true
          # Lower min_area for long driveway (plates will be smaller)
          min_area: 300
        motion:
          improve_contrast: false
        ffmpeg:
          inputs:
            - path: rtsp://admin:{FRIGATE_RTSP_PASSWORD}@192.168.1.21:554/ch1/main/av_stream
              roles:
                - record
            - path: rtsp://admin:{FRIGATE_RTSP_PASSWORD}@192.168.1.21:554/ch1/sub/av_stream
              roles:
                - detect

      back:
        enabled: true
        detect:
          enabled: false
          width: 640
          height: 360
          fps: 12
        lpr:
          enabled: false
        motion:
          improve_contrast: false
        ffmpeg:
          inputs:
            - path: rtsp://admin:{FRIGATE_RTSP_PASSWORD}@192.168.1.22:554/ch1/main/av_stream
              roles:
                - record
            - path: rtsp://admin:{FRIGATE_RTSP_PASSWORD}@192.168.1.22:554/ch1/sub/av_stream
              roles:
                - detect

    # go2rtc configuration for HD live streaming
    go2rtc:
      streams:
        front:
          - rtsp://admin:{FRIGATE_RTSP_PASSWORD}@192.168.1.20:554/ch1/main/av_stream
        gate:
          - rtsp://admin:{FRIGATE_RTSP_PASSWORD}@192.168.1.21:554/ch1/main/av_stream
        back:
          - rtsp://admin:{FRIGATE_RTSP_PASSWORD}@192.168.1.22:554/ch1/main/av_stream
