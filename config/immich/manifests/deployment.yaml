# Immich Server Deployment
# Main API server and web interface
#
# Handles: authentication, uploads, API, background jobs
# All persistent data is stored in PVCs
#
# Hardware Transcoding: Intel Quick Sync (QSV) / VAAPI enabled via /dev/dri passthrough
# Odroid H3+/Ultra use Intel Celeron N5105 with UHD Graphics (Jasper Lake)

apiVersion: apps/v1
kind: Deployment
metadata:
  name: immich-server
  namespace: immich
  labels:
    app: immich-server
  annotations:
    argocd.argoproj.io/sync-wave: "2"
spec:
  replicas: 1
  strategy:
    type: Recreate  # Required for RWO PVCs
  selector:
    matchLabels:
      app: immich-server
  template:
    metadata:
      labels:
        app: immich-server
      annotations:
        # Auto-restart when OIDC secret changes (requires Reloader)
        secret.reloader.stakater.com/reload: "immich-oidc"
    spec:
      initContainers:
        # Create .immich marker files in each bucket for mount verification
        # These will be visible through the merged view
        - name: init-bucket-markers
          image: busybox:1.36@sha256:6b219909078e3fc93b81f83cb438bd7a5457984a01a478c76fe9777a8c67c39e
          command:
            - 'sh'
            - '-c'
            - |
              # Create markers in each library bucket
              for dir in /mnt/library-buckets/*; do
                if [ -d "$dir" ] && [ ! -f "$dir/.immich" ]; then
                  echo "Creating mount marker in $dir"
                  touch "$dir/.immich"
                fi
              done
              # Create markers in other volumes
              for dir in /mnt/upload /mnt/thumbs /mnt/encoded-video /mnt/profile /mnt/backups; do
                if [ ! -f "$dir/.immich" ]; then
                  echo "Creating mount marker in $dir"
                  touch "$dir/.immich"
                fi
              done
              echo "Mount markers ready!"
          volumeMounts:
            - name: library-bucket-01
              mountPath: /mnt/library-buckets/01
            - name: library-bucket-02
              mountPath: /mnt/library-buckets/02
            - name: library-bucket-03
              mountPath: /mnt/library-buckets/03
            - name: library-bucket-04
              mountPath: /mnt/library-buckets/04
            - name: library-bucket-05
              mountPath: /mnt/library-buckets/05
            - name: library-bucket-06
              mountPath: /mnt/library-buckets/06
            - name: upload
              mountPath: /mnt/upload
            - name: thumbs
              mountPath: /mnt/thumbs
            - name: encoded-video
              mountPath: /mnt/encoded-video
            - name: profile
              mountPath: /mnt/profile
            - name: backups
              mountPath: /mnt/backups
        # Wait for PostgreSQL to be ready
        - name: wait-for-postgres
          image: busybox:1.36@sha256:6b219909078e3fc93b81f83cb438bd7a5457984a01a478c76fe9777a8c67c39e
          command:
            - 'sh'
            - '-c'
            - |
              until nc -z immich-db-rw.immich.svc.cluster.local 5432; do
                echo "Waiting for PostgreSQL..."
                sleep 2
              done
              echo "PostgreSQL is ready!"
        # Wait for Redis to be ready
        - name: wait-for-redis
          image: busybox:1.36@sha256:6b219909078e3fc93b81f83cb438bd7a5457984a01a478c76fe9777a8c67c39e
          command:
            - 'sh'
            - '-c'
            - |
              until nc -z redis.immich.svc.cluster.local 6379; do
                echo "Waiting for Redis..."
                sleep 2
              done
              echo "Redis is ready!"
      
      containers:
        # MergerFS sidecar - combines library buckets into unified view
        # Uses 'lfs' policy: fills buckets one-by-one (least free space first)
        - name: mergerfs
          image: ghcr.io/hotio/mergerfs:release-2.40.2
          securityContext:
            privileged: true  # Required for FUSE mount
          command:
            - mergerfs
            - '-f'  # Foreground mode (required for container)
            - '-o'
            - 'defaults,allow_other,use_ino,cache.files=partial,dropcacheonclose=true,category.create=lfs,minfreespace=10G'
            - '/mnt/library-buckets/01:/mnt/library-buckets/02:/mnt/library-buckets/03:/mnt/library-buckets/04:/mnt/library-buckets/05:/mnt/library-buckets/06'
            - '/mnt/merged-library'
          volumeMounts:
            - name: library-bucket-01
              mountPath: /mnt/library-buckets/01
            - name: library-bucket-02
              mountPath: /mnt/library-buckets/02
            - name: library-bucket-03
              mountPath: /mnt/library-buckets/03
            - name: library-bucket-04
              mountPath: /mnt/library-buckets/04
            - name: library-bucket-05
              mountPath: /mnt/library-buckets/05
            - name: library-bucket-06
              mountPath: /mnt/library-buckets/06
            - name: merged-library
              mountPath: /mnt/merged-library
              mountPropagation: Bidirectional
          resources:
            requests:
              cpu: 10m
              memory: 32Mi
            limits:
              cpu: 500m
              memory: 128Mi
          livenessProbe:
            exec:
              command: ['test', '-d', '/mnt/merged-library']
            periodSeconds: 30
          readinessProbe:
            exec:
              command: ['test', '-d', '/mnt/merged-library']
            periodSeconds: 10

        - name: immich-server
          image: ghcr.io/immich-app/immich-server:v2.4.1
          # GPU access for hardware transcoding (Intel QSV/VAAPI)
          securityContext:
            privileged: false
          ports:
            - containerPort: 2283
              name: http
          env:
            # ===================
            # Database Configuration
            # ===================
            - name: DB_HOSTNAME
              value: "immich-db-rw.immich.svc.cluster.local"
            - name: DB_PORT
              value: "5432"
            - name: DB_DATABASE_NAME
              value: "immich"
            - name: DB_USERNAME
              valueFrom:
                secretKeyRef:
                  name: immich-db-app
                  key: username
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: immich-db-app
                  key: password
            
            # ===================
            # Redis Configuration
            # ===================
            - name: REDIS_HOSTNAME
              value: "redis.immich.svc.cluster.local"
            - name: REDIS_PORT
              value: "6379"
            
            # ===================
            # Storage Paths
            # ===================
            - name: IMMICH_MEDIA_LOCATION
              value: "/usr/src/app/upload"
            
            # ===================
            # Server Configuration
            # ===================
            - name: IMMICH_HOST
              value: "0.0.0.0"
            - name: IMMICH_PORT
              value: "2283"
            
            # ===================
            # OIDC Configuration
            # ===================
            # NOTE: In Immich v2.x, OIDC is configured via the Admin UI
            # Go to: Administration → Settings → OAuth Authentication
            # See README.md for setup instructions
            
            # ===================
            # Machine Learning Service
            # ===================
            - name: IMMICH_MACHINE_LEARNING_URL
              value: "http://immich-ml.immich.svc.cluster.local:3003"
            
            # ===================
            # Logging
            # ===================
            - name: LOG_LEVEL
              value: "log"
          
          volumeMounts:
            # Merged library - unified view of all library buckets via mergerfs
            - name: merged-library
              mountPath: /usr/src/app/upload/library
              mountPropagation: HostToContainer
            # Upload buffer - incoming files
            - name: upload
              mountPath: /usr/src/app/upload/upload
            # Thumbnails
            - name: thumbs
              mountPath: /usr/src/app/upload/thumbs
            # Encoded videos
            - name: encoded-video
              mountPath: /usr/src/app/upload/encoded-video
            # Profile pictures
            - name: profile
              mountPath: /usr/src/app/upload/profile
            # Backups
            - name: backups
              mountPath: /usr/src/app/upload/backups
            # Import staging area
            - name: import
              mountPath: /import
            # Intel GPU for hardware transcoding (QSV/VAAPI)
            - name: dri
              mountPath: /dev/dri
          
          resources:
            requests:
              cpu: 200m
              memory: 512Mi
            limits:
              cpu: 2000m
              memory: 2Gi
          
          # Startup probe - allows up to 10 minutes for initial startup
          # Immich will refuse to start if library mount is missing (.immich check is built-in)
          startupProbe:
            httpGet:
              path: /api/server/ping
              port: http
            initialDelaySeconds: 10  # Give mergerfs time to mount
            failureThreshold: 60
            periodSeconds: 10
            timeoutSeconds: 5
          livenessProbe:
            httpGet:
              path: /api/server/ping
              port: http
            periodSeconds: 30
            timeoutSeconds: 5
          readinessProbe:
            httpGet:
              path: /api/server/ping
              port: http
            periodSeconds: 10
            timeoutSeconds: 5
      
      volumes:
        # EmptyDir for merged library mount point
        # MergerFS mounts here, combining all library buckets
        - name: merged-library
          emptyDir: {}
        # Library bucket PVCs - combined by mergerfs sidecar
        - name: library-bucket-01
          persistentVolumeClaim:
            claimName: immich-library-01
        - name: library-bucket-02
          persistentVolumeClaim:
            claimName: immich-library-02
        - name: library-bucket-03
          persistentVolumeClaim:
            claimName: immich-library-03
        - name: library-bucket-04
          persistentVolumeClaim:
            claimName: immich-library-04
        - name: library-bucket-05
          persistentVolumeClaim:
            claimName: immich-library-05
        - name: library-bucket-06
          persistentVolumeClaim:
            claimName: immich-library-06
        # Other storage volumes
        - name: upload
          persistentVolumeClaim:
            claimName: immich-upload
        - name: thumbs
          persistentVolumeClaim:
            claimName: immich-thumbs
        - name: encoded-video
          persistentVolumeClaim:
            claimName: immich-encoded-video
        - name: profile
          persistentVolumeClaim:
            claimName: immich-profile
        - name: backups
          persistentVolumeClaim:
            claimName: immich-backups
        - name: import
          persistentVolumeClaim:
            claimName: immich-import
        # Intel GPU device for hardware transcoding
        - name: dri
          hostPath:
            path: /dev/dri
            type: Directory
---
# Immich Server Service
apiVersion: v1
kind: Service
metadata:
  name: immich-server
  namespace: immich
  labels:
    app: immich-server
  annotations:
    argocd.argoproj.io/sync-wave: "2"
spec:
  type: ClusterIP
  selector:
    app: immich-server
  ports:
    - name: http
      port: 2283
      targetPort: 2283
      protocol: TCP

