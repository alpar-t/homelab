# Immich Server Deployment
# Main API server and web interface
#
# Handles: authentication, uploads, API, background jobs
# All persistent data is stored in PVCs
#
# Hardware Transcoding: Intel Quick Sync (QSV) / VAAPI enabled via Intel GPU Device Plugin
# Odroid H3+/Ultra use Intel Celeron N5105 with UHD Graphics (Jasper Lake)
# GPU access is provided by requesting gpu.intel.com/i915 resource

apiVersion: apps/v1
kind: Deployment
metadata:
  name: immich-server
  namespace: immich
  labels:
    app: immich-server
  annotations:
    argocd.argoproj.io/sync-wave: "2"
spec:
  replicas: 1
  strategy:
    type: Recreate  # Required for RWO PVCs
  selector:
    matchLabels:
      app: immich-server
  template:
    metadata:
      labels:
        app: immich-server
      annotations:
        # Auto-restart when OIDC secret changes (requires Reloader)
        secret.reloader.stakater.com/reload: "immich-oidc"
    spec:
      # Prefer scheduling on nodes with high CPU capacity
      # Label nodes with: kubectl label node <node-name> workload/cpu-intensive=true
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              preference:
                matchExpressions:
                  - key: workload/cpu-intensive
                    operator: In
                    values:
                      - "true"
      initContainers:
        # Create .immich marker files in each bucket for mount verification
        # These will be visible through the merged view
        - name: init-bucket-markers
          image: busybox:1.37@sha256:e226d6308690dbe282443c8c7e57365c96b5228f0fe7f40731b5d84d37a06839
          command:
            - 'sh'
            - '-c'
            - |
              # Create markers in each library bucket
              for dir in /mnt/library-buckets/*; do
                if [ -d "$dir" ] && [ ! -f "$dir/.immich" ]; then
                  echo "Creating mount marker in $dir"
                  touch "$dir/.immich"
                fi
              done
              # Create markers in other volumes
              for dir in /mnt/thumbs /mnt/encoded-video /mnt/profile /mnt/backups /mnt/library-empty; do
                if [ ! -f "$dir/.immich" ]; then
                  echo "Creating mount marker in $dir"
                  touch "$dir/.immich"
                fi
              done
              echo "Mount markers ready!"
          volumeMounts:
            - name: library-bucket-01
              mountPath: /mnt/library-buckets/01
            - name: library-bucket-02
              mountPath: /mnt/library-buckets/02
            - name: library-bucket-03
              mountPath: /mnt/library-buckets/03
            - name: library-bucket-04
              mountPath: /mnt/library-buckets/04
            - name: library-bucket-05
              mountPath: /mnt/library-buckets/05
            - name: library-bucket-06
              mountPath: /mnt/library-buckets/06
            - name: thumbs
              mountPath: /mnt/thumbs
            - name: library-empty
              mountPath: /mnt/library-empty
            - name: encoded-video
              mountPath: /mnt/encoded-video
            - name: profile
              mountPath: /mnt/profile
            - name: backups
              mountPath: /mnt/backups
        # Wait for PostgreSQL to be ready
        - name: wait-for-postgres
          image: busybox:1.37@sha256:e226d6308690dbe282443c8c7e57365c96b5228f0fe7f40731b5d84d37a06839
          command:
            - 'sh'
            - '-c'
            - |
              until nc -z immich-db-rw.immich.svc.cluster.local 5432; do
                echo "Waiting for PostgreSQL..."
                sleep 2
              done
              echo "PostgreSQL is ready!"
        # Wait for Redis to be ready
        - name: wait-for-redis
          image: busybox:1.37@sha256:e226d6308690dbe282443c8c7e57365c96b5228f0fe7f40731b5d84d37a06839
          command:
            - 'sh'
            - '-c'
            - |
              until nc -z redis.immich.svc.cluster.local 6379; do
                echo "Waiting for Redis..."
                sleep 2
              done
              echo "Redis is ready!"
      
      containers:
        # MergerFS sidecar - combines library buckets into unified view
        # Uses 'mfs' policy: always creates on bucket with most free space
        # This spreads uploads evenly across all buckets
        - name: mergerfs
          image: ghcr.io/hotio/mergerfs:release-2.40.2
          securityContext:
            privileged: true  # Required for FUSE mount
          command:
            - mergerfs
            - '-f'  # Foreground mode (required for container)
            - '-d'  # Debug mode - verbose logging to stdout
            - '-o'
            - 'defaults,allow_other,use_ino,cache.files=partial,dropcacheonclose=true,category.create=mfs,minfreespace=20G'
            - '/mnt/library-buckets/01:/mnt/library-buckets/02:/mnt/library-buckets/03:/mnt/library-buckets/04:/mnt/library-buckets/05:/mnt/library-buckets/06'
            - '/mnt/merged-library'
          volumeMounts:
            - name: library-bucket-01
              mountPath: /mnt/library-buckets/01
            - name: library-bucket-02
              mountPath: /mnt/library-buckets/02
            - name: library-bucket-03
              mountPath: /mnt/library-buckets/03
            - name: library-bucket-04
              mountPath: /mnt/library-buckets/04
            - name: library-bucket-05
              mountPath: /mnt/library-buckets/05
            - name: library-bucket-06
              mountPath: /mnt/library-buckets/06
            - name: merged-library
              mountPath: /mnt/merged-library
              mountPropagation: Bidirectional
          resources:
            requests:
              cpu: 50m
              memory: 128Mi
            limits:
              cpu: 1000m
              memory: 512Mi
          livenessProbe:
            exec:
              command: ['test', '-d', '/mnt/merged-library']
            periodSeconds: 30
            failureThreshold: 3
          readinessProbe:
            exec:
              command: ['test', '-d', '/mnt/merged-library']
            periodSeconds: 10
            failureThreshold: 3

        - name: immich-server
          image: ghcr.io/immich-app/immich-server:v2.4.1
          # GPU access for hardware transcoding (Intel QSV/VAAPI)
          # GPU is provided by Intel GPU Device Plugin via gpu.intel.com/i915 resource
          securityContext:
            privileged: false
            allowPrivilegeEscalation: false
          ports:
            - containerPort: 2283
              name: http
          env:
            # ===================
            # Database Configuration
            # ===================
            - name: DB_HOSTNAME
              value: "immich-db-rw.immich.svc.cluster.local"
            - name: DB_PORT
              value: "5432"
            - name: DB_DATABASE_NAME
              value: "immich"
            - name: DB_USERNAME
              valueFrom:
                secretKeyRef:
                  name: immich-db-app
                  key: username
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: immich-db-app
                  key: password
            
            # ===================
            # Redis Configuration
            # ===================
            - name: REDIS_HOSTNAME
              value: "redis.immich.svc.cluster.local"
            - name: REDIS_PORT
              value: "6379"
            
            # ===================
            # Storage Paths
            # ===================
            - name: IMMICH_MEDIA_LOCATION
              value: "/usr/src/app/upload"
            
            # ===================
            # Server Configuration
            # ===================
            - name: IMMICH_HOST
              value: "0.0.0.0"
            - name: IMMICH_PORT
              value: "2283"
            
            # ===================
            # OIDC Configuration
            # ===================
            # NOTE: In Immich v2.x, OIDC is configured via the Admin UI
            # Go to: Administration → Settings → OAuth Authentication
            # See README.md for setup instructions
            
            # ===================
            # Machine Learning Service
            # ===================
            - name: IMMICH_MACHINE_LEARNING_URL
              value: "http://immich-ml.immich.svc.cluster.local:3003"
            
            # ===================
            # Logging
            # ===================
            - name: LOG_LEVEL
              value: "log"
          
          volumeMounts:
            # Merged library buckets - stores originals via mergerfs
            # In Immich v1.99+, originals are stored in "upload" path
            - name: merged-library
              mountPath: /usr/src/app/upload/upload
              mountPropagation: HostToContainer
            # Empty library path - Immich requires this for folder integrity checks
            - name: library-empty
              mountPath: /usr/src/app/upload/library
            # Thumbnails
            - name: thumbs
              mountPath: /usr/src/app/upload/thumbs
            # Encoded videos
            - name: encoded-video
              mountPath: /usr/src/app/upload/encoded-video
            # Profile pictures
            - name: profile
              mountPath: /usr/src/app/upload/profile
            # Backups
            - name: backups
              mountPath: /usr/src/app/upload/backups
            # Import staging area
            - name: import
              mountPath: /import
          
          resources:
            requests:
              cpu: 500m
              memory: 1Gi
              # GPU provided by Intel GPU Device Plugin
              gpu.intel.com/i915: 1
            limits:
              cpu: 4000m
              memory: 4Gi
              gpu.intel.com/i915: 1
          
          # Startup probe - allows up to 10 minutes for initial startup
          # Immich will refuse to start if library mount is missing (.immich check is built-in)
          startupProbe:
            httpGet:
              path: /api/server/ping
              port: http
            initialDelaySeconds: 10  # Give mergerfs time to mount
            failureThreshold: 60
            periodSeconds: 10
            timeoutSeconds: 5
          livenessProbe:
            httpGet:
              path: /api/server/ping
              port: http
            periodSeconds: 30
            timeoutSeconds: 5
          readinessProbe:
            httpGet:
              path: /api/server/ping
              port: http
            periodSeconds: 10
            timeoutSeconds: 5
      
      volumes:
        # EmptyDir for merged library mount point
        # MergerFS mounts here, combining all library buckets
        - name: merged-library
          emptyDir: {}
        # Empty library path - Immich requires this for folder integrity checks
        - name: library-empty
          emptyDir: {}
        # Library bucket PVCs - combined by mergerfs sidecar
        - name: library-bucket-01
          persistentVolumeClaim:
            claimName: immich-library-01
        - name: library-bucket-02
          persistentVolumeClaim:
            claimName: immich-library-02
        - name: library-bucket-03
          persistentVolumeClaim:
            claimName: immich-library-03
        - name: library-bucket-04
          persistentVolumeClaim:
            claimName: immich-library-04
        - name: library-bucket-05
          persistentVolumeClaim:
            claimName: immich-library-05
        - name: library-bucket-06
          persistentVolumeClaim:
            claimName: immich-library-06
        # Other storage volumes
        # Upload PVC - kept but NOT mounted (data migrated to mergerfs buckets)
        # Can be deleted after verifying migration is complete
        - name: upload
          persistentVolumeClaim:
            claimName: immich-upload
        - name: thumbs
          persistentVolumeClaim:
            claimName: immich-thumbs
        - name: encoded-video
          persistentVolumeClaim:
            claimName: immich-encoded-video
        - name: profile
          persistentVolumeClaim:
            claimName: immich-profile
        - name: backups
          persistentVolumeClaim:
            claimName: immich-backups
        - name: import
          persistentVolumeClaim:
            claimName: immich-import
        # Note: Intel GPU device is injected by Intel GPU Device Plugin
        # via CDI when gpu.intel.com/i915 resource is requested
---
# Immich Server Service (ClusterIP - internal access via Ingress)
apiVersion: v1
kind: Service
metadata:
  name: immich-server
  namespace: immich
  labels:
    app: immich-server
  annotations:
    argocd.argoproj.io/sync-wave: "2"
spec:
  type: ClusterIP
  selector:
    app: immich-server
  ports:
    - name: http
      port: 2283
      targetPort: 2283
      protocol: TCP
---
# Immich Server LoadBalancer Service (LAN access - bypasses Cloudflare)
# Use this for uploading large files (>100MB) from LAN
# Access at: http://192.168.1.203:2283
apiVersion: v1
kind: Service
metadata:
  name: immich-server-lan
  namespace: immich
  labels:
    app: immich-server
  annotations:
    argocd.argoproj.io/sync-wave: "2"
    metallb.universe.tf/loadBalancerIPs: 192.168.1.203
spec:
  type: LoadBalancer
  selector:
    app: immich-server
  ports:
    - name: http
      port: 2283
      targetPort: 2283
      protocol: TCP
