# Immich Persistent Volume Claims
# Tiered storage: SSD for performance-critical, HDD for bulk storage
#
# Library Storage Architecture:
# =============================
# Instead of one large PVC, we use multiple fixed-size 500Gi "bucket" PVCs.
# This allows each bucket to fit on any node (all nodes have >500Gi available)
# while providing 2-replica redundancy across different nodes.
#
# A mergerfs sidecar combines all buckets into a single unified view at
# /usr/src/app/upload/library. Using the 'lfs' (least free space) policy,
# buckets fill up one-by-one, spreading data across all storage.
#
# Benefits:
#   - True node-level redundancy (2 replicas on different nodes)
#   - Incremental backup/recovery (lose one bucket = lose 500GB, not 3TB)
#   - Simple scaling (add more 500Gi buckets as needed)
#   - Balanced disk usage across all HDDs

---
# Library bucket 01
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: immich-library-01
  namespace: immich
  labels:
    app: immich
    immich-library-bucket: "01"
    # Original photos and videos - irreplaceable user data
    data-criticality: critical
    recurring-job-group.longhorn.io/critical: enabled
  annotations:
    argocd.argoproj.io/sync-wave: "0"
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: longhorn-hdd
  resources:
    requests:
      storage: 500Gi
---
# Library bucket 02
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: immich-library-02
  namespace: immich
  labels:
    app: immich
    immich-library-bucket: "02"
    # Original photos and videos - irreplaceable user data
    data-criticality: critical
    recurring-job-group.longhorn.io/critical: enabled
  annotations:
    argocd.argoproj.io/sync-wave: "0"
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: longhorn-hdd
  resources:
    requests:
      storage: 500Gi
---
# Library bucket 03
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: immich-library-03
  namespace: immich
  labels:
    app: immich
    immich-library-bucket: "03"
    # Original photos and videos - irreplaceable user data
    data-criticality: critical
    recurring-job-group.longhorn.io/critical: enabled
  annotations:
    argocd.argoproj.io/sync-wave: "0"
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: longhorn-hdd
  resources:
    requests:
      storage: 500Gi
---
# Library bucket 04
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: immich-library-04
  namespace: immich
  labels:
    app: immich
    immich-library-bucket: "04"
    # Original photos and videos - irreplaceable user data
    data-criticality: critical
    recurring-job-group.longhorn.io/critical: enabled
  annotations:
    argocd.argoproj.io/sync-wave: "0"
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: longhorn-hdd
  resources:
    requests:
      storage: 500Gi
---
# Library bucket 05
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: immich-library-05
  namespace: immich
  labels:
    app: immich
    immich-library-bucket: "05"
    # Original photos and videos - irreplaceable user data
    data-criticality: critical
    recurring-job-group.longhorn.io/critical: enabled
  annotations:
    argocd.argoproj.io/sync-wave: "0"
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: longhorn-hdd
  resources:
    requests:
      storage: 500Gi
---
# Library bucket 06
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: immich-library-06
  namespace: immich
  labels:
    app: immich
    immich-library-bucket: "06"
    # Original photos and videos - irreplaceable user data
    data-criticality: critical
    recurring-job-group.longhorn.io/critical: enabled
  annotations:
    argocd.argoproj.io/sync-wave: "0"
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: longhorn-hdd
  resources:
    requests:
      storage: 500Gi
---
# Thumbnails - generated previews for fast browsing
# SSD for fast read performance
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: immich-thumbs
  namespace: immich
  labels:
    app: immich
    # Generated from originals - can be regenerated
    data-criticality: rebuildable
  annotations:
    argocd.argoproj.io/sync-wave: "0"
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: longhorn-ssd
  resources:
    requests:
      storage: 100Gi
---
# Upload - temporary buffer for incoming uploads
# SSD for fast writes, 1 replica (temporary data)
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: immich-upload
  namespace: immich
  labels:
    app: immich
    # Temporary staging - files move to library after processing
    data-criticality: rebuildable
  annotations:
    argocd.argoproj.io/sync-wave: "0"
    # Single replica - temporary data, not critical
    longhorn.io/number-of-replicas: "1"
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: longhorn-ssd
  resources:
    requests:
      storage: 50Gi
---
# Encoded video - transcoded versions for streaming
# HDD with 1 replica (regenerable from originals)
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: immich-encoded-video
  namespace: immich
  labels:
    app: immich
    # Transcoded versions - can be regenerated from originals
    data-criticality: rebuildable
  annotations:
    argocd.argoproj.io/sync-wave: "0"
    # Single replica - can be regenerated from originals
    longhorn.io/number-of-replicas: "1"
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: longhorn-hdd
  resources:
    requests:
      storage: 500Gi
---
# Profile - user profile pictures
# SSD, small volume
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: immich-profile
  namespace: immich
  labels:
    app: immich
    # User profile pictures - user-uploaded content
    data-criticality: critical
    recurring-job-group.longhorn.io/critical: enabled
  annotations:
    argocd.argoproj.io/sync-wave: "0"
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: longhorn-ssd
  resources:
    requests:
      storage: 1Gi
---
# Import - staging area for bulk imports via kubectl cp
# HDD with 1 replica (temporary staging, source files exist elsewhere)
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: immich-import
  namespace: immich
  labels:
    app: immich
    # Temporary staging - source files exist elsewhere
    data-criticality: rebuildable
  annotations:
    argocd.argoproj.io/sync-wave: "0"
    # Single replica - temporary staging area
    longhorn.io/number-of-replicas: "1"
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: longhorn-hdd
  resources:
    requests:
      storage: 500Gi
---
# Backups - database and configuration backups
# SSD with 2 replicas for data safety
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: immich-backups
  namespace: immich
  labels:
    app: immich
    # Database and configuration backups - important for recovery
    data-criticality: critical
    recurring-job-group.longhorn.io/critical: enabled
  annotations:
    argocd.argoproj.io/sync-wave: "0"
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: longhorn-ssd
  resources:
    requests:
      storage: 10Gi
---
# ML model cache - stores downloaded ML models
# SSD for fast loading
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: immich-model-cache
  namespace: immich
  labels:
    app: immich
    # Downloaded ML models - can be re-downloaded
    data-criticality: rebuildable
  annotations:
    argocd.argoproj.io/sync-wave: "0"
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: longhorn-ssd
  resources:
    requests:
      storage: 10Gi

