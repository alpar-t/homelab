apiVersion: apps/v1
kind: Deployment
metadata:
  name: mail-relay
  namespace: mail-relay
  labels:
    app: mail-relay
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mail-relay
  template:
    metadata:
      labels:
        app: mail-relay
    spec:
      containers:
        - name: postfix
          # Pinned version - see /CLOUD.md for update instructions
          image: boky/postfix:v4.4.0@sha256:f3f247fd42528b969e2603ac120d5a5b5db7dfe61f4505c49d438b9ba1822999
          ports:
            - containerPort: 25
              name: smtp
          env:
            # Migadu SMTP relay configuration
            - name: RELAYHOST
              value: "[smtp.migadu.com]:587"
            - name: RELAYHOST_USERNAME
              valueFrom:
                secretKeyRef:
                  name: migadu-credentials
                  key: username
            - name: RELAYHOST_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: migadu-credentials
                  key: password
            # Allow sending from cluster networks
            - name: ALLOWED_SENDER_DOMAINS
              value: "newjoy.ro"
            - name: MYNETWORKS
              value: "10.0.0.0/8 172.16.0.0/12 192.168.0.0/16 127.0.0.0/8"
            # Hostname for HELO/EHLO
            - name: HOSTNAME
              value: "mail.newjoy.ro"
            # Queue settings for resilience
            - name: POSTFIX_maximal_queue_lifetime
              value: "5d"
            - name: POSTFIX_bounce_queue_lifetime
              value: "5d"
            - name: POSTFIX_minimal_backoff_time
              value: "300s"
            - name: POSTFIX_maximal_backoff_time
              value: "4000s"
          resources:
            requests:
              cpu: 10m
              memory: 32Mi
            limits:
              cpu: 100m
              memory: 128Mi
          livenessProbe:
            tcpSocket:
              port: smtp
            initialDelaySeconds: 10
            periodSeconds: 30
          readinessProbe:
            tcpSocket:
              port: smtp
            initialDelaySeconds: 5
            periodSeconds: 10
          volumeMounts:
            - name: mail-queue
              mountPath: /var/spool/postfix
      volumes:
        - name: mail-queue
          persistentVolumeClaim:
            claimName: mail-queue-pvc

