# OnlyOffice Document Server Helm Chart Values
# https://github.com/ONLYOFFICE/Kubernetes-Docs

# JWT disabled for WOPI mode - oCIS WOPI handles authentication via WOPI tokens
# Note: JWT and WOPI are different auth mechanisms:
# - JWT: Direct API access protection (e.g., Nextcloud integration)
# - WOPI: Token-based protocol where oCIS generates access tokens per document
jwt:
  enabled: false

# Enable WOPI support for oCIS integration
# This enables the /hosting/discovery endpoint
# WOPI provides security through time-limited access tokens generated by oCIS
wopi:
  enabled: true

# Allow connections from both internal (oCIS collaboration) and external (browser)
connections:
  allowPrivateIPAddress: true
  allowMetaIPAddress: true
  # Database connection - CloudNativePG creates secret: onlyoffice-postgresql-app
  dbExistingSecret: "onlyoffice-postgresql-app"
  dbSecretKeyName: "password"
  dbHost: "onlyoffice-postgresql-rw"
  dbName: onlyoffice
  dbUser: onlyoffice
  # Use existing Redis from paperless-ngx (passwordless)
  redisHost: "redis.paperless-ngx.svc.cluster.local"
  redisNoPass: true
  # External RabbitMQ connection (deployed via manifests/rabbitmq.yaml)
  amqpHost: "rabbitmq"
  amqpPort: "5672"
  amqpUser: "onlyoffice"
  amqpProto: "amqp"
  amqpExistingSecret: "rabbitmq"
  amqpSecretKeyName: "rabbitmq-password"

# Persistence for document server data
persistence:
  enabled: true
  storageClass: longhorn-ssd
  size: 10Gi

# Resource limits
resources:
  requests:
    cpu: 100m
    memory: 512Mi
  limits:
    cpu: 2000m
    memory: 2Gi

# Disable bundled PostgreSQL - we use CloudNativePG
postgresql:
  enabled: false

# Disable bundled RabbitMQ - we deploy it separately via manifests
# (Helm subcharts don't work well with ArgoCD multi-source applications)
rabbitmq:
  enabled: false

# Disable bundled Redis - we use existing one from paperless-ngx
redis:
  enabled: false

# Service configuration
service:
  type: ClusterIP
  port: 80

# Enable ingress for browser access
# Security: OnlyOffice is protected by WOPI tokens from oCIS - only users with valid
# oCIS sessions can open documents (oCIS generates time-limited WOPI access tokens)
ingress:
  enabled: true
  ingressClassName: nginx
  host: office.newjoy.ro
  ssl:
    enabled: false  # TLS handled by ingress-nginx
  annotations:
    nginx.ingress.kubernetes.io/proxy-body-size: "100m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"

# Probes - OnlyOffice takes a while to start
probes:
  startup:
    enabled: true
    initialDelaySeconds: 30
    periodSeconds: 10
    failureThreshold: 30
  readiness:
    enabled: true
    periodSeconds: 10
  liveness:
    enabled: true
    periodSeconds: 30

# Disable upgrade job for initial install (causes chicken-egg problem)
upgrade:
  job:
    enabled: false

# Enable example component - provides /hosting/discovery WOPI endpoint
# Required for oCIS collaboration integration
example:
  enabled: true
