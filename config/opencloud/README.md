# OpenCloud

Cloud file storage and collaboration platform with Pocket ID for SSO.

OpenCloud is a community fork of ownCloud Infinite Scale (oCIS).

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                        Ingress                               │
│              drive.newjoy.ro / office.newjoy.ro              │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                     OpenCloud (Helm Chart)                   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              OpenCloud Pod                           │   │
│  │    (file sync, sharing, web UI)                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                              │                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │           Collaboration Service (WOPI)               │   │
│  │    (bridges OpenCloud ↔ OnlyOffice)                 │   │
│  └─────────────────────────────────────────────────────┘   │
│                              │                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              OnlyOffice Document Server              │   │
│  │    (document editing: Word, Excel, PowerPoint)      │   │
│  └─────────────────────────────────────────────────────┘   │
│                              │                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              PosixFS Storage (longhorn-hdd)          │   │
│  │                      3TB PVC                         │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────┐
│  Pocket ID  │
│   (OIDC)    │
│auth.newjoy.ro│
└─────────────┘
```

## Deployment

Uses the [OpenCloud Community Helm Chart](https://github.com/opencloud-eu/helm).

Key configuration:
- **External OIDC**: Pocket ID at `auth.newjoy.ro`
- **Storage**: PosixFS with Longhorn HDD (3TB)
- **Keycloak**: Disabled (using Pocket ID instead)
- **MinIO/S3**: Disabled (using PosixFS for simplicity)
- **OnlyOffice**: Built-in (managed by the Helm chart)
- **Collaboration**: WOPI service for document editing

## Prerequisites in Pocket ID

### 1. Create OIDC Client (Web)

1. **Name**: OpenCloud
2. **Callback URLs**: 
   - `https://drive.newjoy.ro/`
   - `https://drive.newjoy.ro/oidc-callback.html`
   - `https://drive.newjoy.ro/oidc-silent-redirect.html`
3. **Public Client**: Yes
4. Copy Client ID to the ArgoCD Application values

### 2. Create Desktop/Mobile Clients

OpenCloud has its own native apps with hardcoded Client IDs. Create as **Public Clients**:

| App | Client ID | Callback URL |
|-----|-----------|--------------|
| Desktop | `OpenCloudDesktop` | `http://127.0.0.1` |
| iOS | `OpenCloudIOS` | `oc://ios.opencloud.eu` |
| Android | `OpenCloudAndroid` | `oc://android.opencloud.eu` |

### Download Apps

- **Desktop**: [GitHub Releases](https://github.com/opencloud-eu/desktop/releases)
- **iOS**: App Store (search "OpenCloud")
- **Android**: Play Store (search "OpenCloud")

## Secrets

Secrets are generated by a PreSync job (`manifests/secrets-job.yaml`):
- `opencloud-admin`: Admin password (auto-generated)

## Components

| Component | Purpose |
|-----------|---------|
| OpenCloud | Main file sync & sharing server |
| Collaboration | WOPI server bridging OpenCloud ↔ OnlyOffice |
| OnlyOffice | Document editing (Word, Excel, PowerPoint, embedded PostgreSQL) |

## Troubleshooting

```bash
# Check all pods
kubectl get pods -n opencloud

# View OpenCloud logs
kubectl logs -n opencloud -l app.kubernetes.io/name=opencloud -f

# View OnlyOffice logs
kubectl logs -n opencloud -l app.kubernetes.io/component=onlyoffice -f

# View Collaboration service logs
kubectl logs -n opencloud -l app.kubernetes.io/component=collaboration -f

# Check secrets were generated
kubectl get secrets -n opencloud
```

### Fresh Deployment

If secrets are mismatched, delete everything and let ArgoCD recreate:

```bash
kubectl delete secrets -n opencloud --all
kubectl delete pvc -n opencloud --all
# Then sync ArgoCD
```

## Migration from ownCloud

Since data is not being migrated, simply:
1. Sync files to local machine using ownCloud desktop client
2. Delete ownCloud from ArgoCD
3. Deploy OpenCloud
4. Download and install OpenCloud desktop client
5. Configure to sync to `drive.newjoy.ro`
6. Wait for files to re-upload

## References

- [OpenCloud Helm Charts](https://github.com/opencloud-eu/helm)
- [OpenCloud Documentation](https://docs.opencloud.eu/)
- [OpenCloud Desktop Releases](https://github.com/opencloud-eu/desktop/releases)
- [Pocket ID OIDC Integration](https://pocket-id.org/docs/)
