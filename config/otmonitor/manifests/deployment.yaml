apiVersion: apps/v1
kind: Deployment
metadata:
  name: otmonitor
  namespace: otmonitor
  labels:
    app: otmonitor
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: otmonitor
  template:
    metadata:
      labels:
        app: otmonitor
      annotations:
        # Auto-restart when config changes (requires Reloader)
        configmap.reloader.stakater.com/reload: "otmonitor-config"
        secret.reloader.stakater.com/reload: "otmonitor-secrets"
    spec:
      initContainers:
        # Generate config file with secrets using envsubst
        # OTMonitor is started with -f /config/otmonitor.conf
        - name: generate-config
          image: bhgedigital/envsubst:latest@sha256:36a92e9344ef965e9318c8d2f70dd35cad654a4615b889c6a4dd483ca1ddec7c
          command: ['sh', '-c']
          args:
            - |
              envsubst < /config-template/otmonitor.conf > /config/otmonitor.conf
              echo "Config generated at /config/otmonitor.conf:"
              cat /config/otmonitor.conf
          envFrom:
            - secretRef:
                name: otmonitor-secrets
          volumeMounts:
            - name: config-template
              mountPath: /config-template
            - name: config
              mountPath: /config
      containers:
        - name: otmonitor
          image: ghcr.io/alpar-t/otmonitor:latest@sha256:fccd308a7ea21f31c2f2a33b3f198eb49f3b2303d6fe0d94d650bd308ff6194b
          env:
            - name: TZ
              value: "Europe/Bucharest"
            - name: GROUP_ID
              value: "1000"
            - name: USER_ID
              value: "1000"
            - name: UMASK
              value: "002"
            - name: KEEP_APP_RUNNING
              value: "1"
            - name: DISPLAY_WIDTH
              value: "1800"
            - name: DISPLAY_HEIGHT
              value: "950"
          ports:
            # Web GUI (jlesage-style VNC web interface)
            - name: http
              containerPort: 5800
              protocol: TCP
            # OTMonitor native port
            - name: otmonitor
              containerPort: 7686
              protocol: TCP
          volumeMounts:
            - name: config
              mountPath: /config
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 512Mi
          livenessProbe:
            httpGet:
              path: /
              port: 5800
            initialDelaySeconds: 60
            periodSeconds: 30
            timeoutSeconds: 10
          readinessProbe:
            httpGet:
              path: /
              port: 5800
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
        # Sidecar to tail OTMonitor logs to stdout for kubectl logs
        - name: log-tailer
          image: busybox:1.37@sha256:e226d6308690dbe282443c8c7e57365c96b5228f0fe7f40731b5d84d37a06839
          command: ['sh', '-c']
          args:
            - |
              mkdir -p /config/logs
              # Wait for log files to appear, then tail them
              while true; do
                if ls /config/logs/otlog-*.txt 1>/dev/null 2>&1; then
                  tail -F /config/logs/otlog-*.txt
                else
                  echo "Waiting for OTMonitor logs..."
                  sleep 5
                fi
              done
          volumeMounts:
            - name: config
              mountPath: /config
          resources:
            requests:
              cpu: 5m
              memory: 8Mi
            limits:
              cpu: 50m
              memory: 32Mi
      volumes:
        - name: config-template
          configMap:
            name: otmonitor-config
        - name: config
          emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: otmonitor
  namespace: otmonitor
  labels:
    app: otmonitor
spec:
  type: ClusterIP
  selector:
    app: otmonitor
  ports:
    - name: http
      port: 80
      targetPort: 5800
      protocol: TCP
    - name: otmonitor
      port: 7686
      targetPort: 7686
      protocol: TCP

