# ownCloud Infinite Scale Helm Chart Values
# https://github.com/owncloud/ocis-charts

# ===================
# External Access
# ===================
externalDomain: drive.newjoy.ro

# ===================
# Features
# ===================
features:
  # Enable external user management (Pocket ID)
  externalUserManagement:
    enabled: true
    # OIDC configuration for Pocket ID
    oidc:
      issuerURI: https://auth.newjoy.ro
      userIDClaim: preferred_username
      userIDClaimAttributeMapping: username
      accessTokenVerifyMethod: jwt
    # Auto-provision accounts from OIDC
    autoprovisionAccounts:
      enabled: true
      claimEmail: email
      claimDisplayname: name
      claimGroups: groups
      claimUserName: preferred_username
    # LDAP must be writable for auto-provisioning to work
    ldap:
      writeable: true
  
  # Email notifications via Stalwart
  emailNotifications:
    enabled: true
    smtp:
      host: stalwart.stalwart-mail.svc.cluster.local
      port: 25
      sender: "ownCloud <service@newjoy.ro>"
      authentication: none
      encryption: none
  
  # Apps integration (OnlyOffice)
  appsIntegration:
    enabled: true
    wopiIntegration:
      officeSuites:
        - name: OnlyOffice
          product: OnlyOffice
          enabled: true
          # OnlyOffice Helm chart creates service named 'documentserver'
          uri: http://documentserver.owncloud.svc.cluster.local
          insecure: true
          disableProof: false
          secureViewEnabled: false
          disableChat: false
          ingress:
            enabled: false
            domain: ""
            ingressClassName: null
            annotations: {}
            labels: {}
            tls: []

# ===================
# HTTP / CSP Configuration
# ===================
# CSP settings to allow external OIDC provider
http:
  csp:
    directives:
      connectSrc:
        - "'self'"
        - "blob:"
        - "https://auth.newjoy.ro"
      frameSrc:
        - "'self'"
        - "blob:"
        - "https://auth.newjoy.ro"

# ===================
# Ingress Configuration
# ===================
# Note: TLS is handled by Cloudflare tunnel, not at the ingress level
ingress:
  enabled: true
  ingressClassName: nginx
  annotations:
    nginx.ingress.kubernetes.io/proxy-body-size: "0"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "600"
  tls: []

# ===================
# Secrets Configuration
# ===================
# Auto-generate secrets on first install
secretRefs:
  # JWT secret for internal service communication
  jwtSecretRef: owncloud-jwt-secret
  # Machine auth API key
  machineAuthApiKeySecretRef: owncloud-machine-auth
  # Transfer secret
  transferSecretSecretRef: owncloud-transfer-secret
  # Thumbnails transfer secret
  thumbnailsSecretRef: owncloud-thumbnails-secret
  # Admin user secret (for initial setup)
  adminUserSecretRef: owncloud-admin-secret

# ===================
# Storage Configuration
# ===================
services:
  storageusers:
    persistence:
      enabled: true
      storageClassName: longhorn-hdd
      size: 1500Gi
    storageBackend:
      driver: ocis
  
  # Search service with Tika integration
  search:
    persistence:
      enabled: true
      storageClassName: longhorn-ssd
      size: 15Gi
    extractor:
      type: tika
      tika:
        url: http://tika.paperless-ngx.svc.cluster.local:9998
  
  # Thumbnails service
  thumbnails:
    persistence:
      enabled: true
      storageClassName: longhorn-ssd
      size: 30Gi
  
  # Web frontend configuration
  web:
    persistence:
      enabled: false
    # OIDC client configuration for the web frontend
    config:
      oidc:
        # Client ID must match the Pocket ID OIDC client
        webClientID: owncloud
  
  # IDM (Identity Management)
  idm:
    persistence:
      enabled: true
      storageClassName: longhorn-ssd
      size: 1Gi
  
  # NATS for internal messaging
  nats:
    persistence:
      enabled: true
      storageClassName: longhorn-ssd
      size: 1Gi

# ===================
# Resource Limits
# ===================
# Reasonable defaults for a small deployment (~6 users)
resources:
  limits:
    cpu: 2000m
    memory: 2Gi
  requests:
    cpu: 200m
    memory: 512Mi
