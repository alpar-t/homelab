# ownCloud Infinite Scale Helm Chart Values
# https://github.com/owncloud/ocis-charts

# ===================
# External Access
# ===================
externalDomain: drive.newjoy.ro

# ===================
# Features
# ===================
features:
  # External OIDC authentication via Pocket ID + LLDAP for user storage
  externalUserManagement:
    enabled: true
    # OIDC configuration for Pocket ID
    oidc:
      issuerURI: https://auth.newjoy.ro
      # Use preferred_username as the user identifier
      userIDClaim: preferred_username
      userIDClaimAttributeMapping: username
      accessTokenVerifyMethod: jwt
      # Role assignment from OIDC claims
      # Maps Pocket ID group claims to oCIS roles
      roleAssignment:
        enabled: true
        claim: roles
        mapping:
          - role_name: admin
            claim_value: advanced_apps
          - role_name: user
            claim_value: family_users
    # Auto-provision accounts from OIDC claims into LLDAP
    autoprovisionAccounts:
      enabled: true
      claimEmail: email
      claimDisplayname: name
      claimGroups: groups
      claimUserName: preferred_username
    # LLDAP backend for user storage (same namespace)
    ldap:
      uri: ldap://lldap:3890
      bindDN: uid=admin,ou=people,dc=newjoy,dc=ro
      writeable: true
      insecure: true
      certTrusted: true
      useServerUUID: true
      refintEnabled: false
      passwordModifyExOpEnabled: false
      user:
        schema:
          id: entryUUID
          mail: mail
          displayName: displayName
          userName: uid
        baseDN: ou=people,dc=newjoy,dc=ro
        scope: one
        filter: "(objectClass=person)"
        objectClass: inetOrgPerson
      group:
        schema:
          id: entryUUID
          groupName: cn
          member: member
        baseDN: ou=groups,dc=newjoy,dc=ro
        scope: one
        filter: "(objectClass=groupOfUniqueNames)"
        objectClass: groupOfUniqueNames
  
  # Email notifications via Stalwart
  emailNotifications:
    enabled: true
    smtp:
      host: stalwart.stalwart-mail.svc.cluster.local
      port: 25
      sender: "ownCloud <service@newjoy.ro>"
      authentication: none
      encryption: none
  
  # Apps integration (OnlyOffice)
  appsIntegration:
    enabled: true
    wopiIntegration:
      officeSuites:
        - name: OnlyOffice
          product: OnlyOffice
          enabled: true
          # OnlyOffice Helm chart creates service named 'documentserver'
          uri: http://documentserver.owncloud.svc.cluster.local
          insecure: true
          disableProof: false
          secureViewEnabled: false
          disableChat: false
          # Icon URL required by oCIS Web UI
          iconURI: https://cdn.jsdelivr.net/npm/simple-icons@v9/icons/onlyoffice.svg
          ingress:
            enabled: false
            domain: ""
            ingressClassName: null
            annotations: {}
            labels: {}
            tls: []

# ===================
# HTTP / CSP Configuration
# ===================
# CSP settings to allow external OIDC provider (Pocket ID)
http:
  csp:
    directives:
      connectSrc:
        - "'self'"
        - "blob:"
        - "https://auth.newjoy.ro"
      frameSrc:
        - "'self'"
        - "blob:"
        - "https://auth.newjoy.ro"

# ===================
# Ingress Configuration
# ===================
# Note: TLS is handled by Cloudflare tunnel, not at the ingress level
ingress:
  enabled: true
  ingressClassName: nginx
  annotations:
    nginx.ingress.kubernetes.io/proxy-body-size: "0"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "600"
  tls: []

# ===================
# Secrets Configuration
# ===================
# Let the Helm chart auto-generate all secrets on first install
# Do NOT specify secretRefs - the chart will create them automatically

# ===================
# Security Context
# ===================
# Fix permissions on Longhorn volumes
securityContext:
  fsGroup: 1000
  fsGroupChangePolicy: Always
  runAsUser: 1000
  runAsGroup: 1000

# ===================
# Storage Configuration
# ===================
services:
  storageusers:
    persistence:
      enabled: true
      chownInitContainer: true
      storageClassName: longhorn-hdd
      size: 1500Gi
    storageBackend:
      driver: ocis
  
  # Search service with Tika integration
  search:
    persistence:
      enabled: true
      chownInitContainer: true
      storageClassName: longhorn-ssd
      size: 15Gi
    extractor:
      type: tika
      tika:
        url: http://tika.paperless-ngx.svc.cluster.local:9998
  
  # Thumbnails service
  thumbnails:
    persistence:
      enabled: true
      chownInitContainer: true
      storageClassName: longhorn-ssd
      size: 30Gi
  
  # Web frontend configuration
  web:
    persistence:
      enabled: false
    # OIDC client configuration for the web frontend
    config:
      oidc:
        # Client ID must match the Pocket ID OIDC client
        webClientID: b85f28eb-bf7d-4544-a311-eadcd5c09a2d
  
  # NATS for internal messaging
  nats:
    persistence:
      enabled: true
      chownInitContainer: true
      storageClassName: longhorn-ssd
      size: 1Gi

# ===================
# Resource Limits
# ===================
# Reasonable defaults for a small deployment (~6 users)
resources:
  limits:
    cpu: 2000m
    memory: 2Gi
  requests:
    cpu: 200m
    memory: 512Mi
