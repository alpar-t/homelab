# ownCloud Infinite Scale Deployment
#
# Uses Posix FS driver for easy file migration (just cp files in)
# Configured for external OIDC authentication via Pocket ID
# Integrated with OnlyOffice for document editing
#
# Storage layout:
# - /var/lib/ocis/storage (HDD) - user files
# - /var/lib/ocis/config (SSD) - config and metadata
# - /var/lib/ocis/thumbnails (SSD) - thumbnail cache
# - /var/lib/ocis/search (SSD) - search index

apiVersion: apps/v1
kind: Deployment
metadata:
  name: owncloud
  namespace: owncloud
  labels:
    app: owncloud
  annotations:
    argocd.argoproj.io/sync-wave: "2"
spec:
  replicas: 1
  strategy:
    type: Recreate  # Required for RWO PVCs
  selector:
    matchLabels:
      app: owncloud
  template:
    metadata:
      labels:
        app: owncloud
      annotations:
        # Auto-restart when secrets change (requires Reloader)
        secret.reloader.stakater.com/reload: "owncloud-secrets,owncloud-oidc,owncloud-email"
    spec:
      # Run as oCIS user (UID 1000)
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
      initContainers:
        # Clear corrupted search index (one-time fix)
        # TODO: Remove this init container after search index is fixed
        - name: clear-search-index
          image: busybox:stable
          command:
            - /bin/sh
            - -c
            - |
              echo "Checking search index..."
              if [ -d /var/lib/ocis/search/bleve ]; then
                echo "Found existing search index, clearing it..."
                rm -rf /var/lib/ocis/search/bleve
                echo "Search index cleared"
              else
                echo "No search index found, nothing to clear"
              fi
          volumeMounts:
            - name: search
              mountPath: /var/lib/ocis/search
          securityContext:
            runAsUser: 1000
            runAsGroup: 1000
        # Initialize oCIS config if not present
        - name: init-config
          image: owncloud/ocis:7.0.0
          command:
            - /bin/sh
            - -c
            - |
              # Only initialize if config doesn't exist
              if [ ! -f /etc/ocis/ocis.yaml ]; then
                echo "Initializing oCIS configuration..."
                ocis init --config-path /etc/ocis
              else
                echo "Configuration already exists, skipping init"
              fi
          env:
            - name: OCIS_URL
              value: "https://drive.newjoy.ro"
            - name: OCIS_INSECURE
              value: "false"
          volumeMounts:
            - name: config
              mountPath: /etc/ocis
          securityContext:
            runAsUser: 1000
            runAsGroup: 1000
      containers:
        - name: owncloud
          image: owncloud/ocis:7.0.0
          ports:
            - containerPort: 9200
              name: https
          env:
            # ===================
            # Core Configuration
            # ===================
            - name: OCIS_URL
              value: "https://drive.newjoy.ro"
            - name: OCIS_LOG_LEVEL
              value: "info"
            - name: OCIS_LOG_PRETTY
              value: "true"
            - name: OCIS_CONFIG_DIR
              value: "/etc/ocis"
            
            # Proxy configuration (behind ingress)
            - name: PROXY_HTTP_ADDR
              value: "0.0.0.0:9200"
            - name: PROXY_TLS
              value: "false"  # TLS terminated at ingress
            
            # ===================
            # Security Secrets
            # ===================
            - name: OCIS_JWT_SECRET
              valueFrom:
                secretKeyRef:
                  name: owncloud-secrets
                  key: jwt-secret
            - name: OCIS_MACHINE_AUTH_API_KEY
              valueFrom:
                secretKeyRef:
                  name: owncloud-secrets
                  key: machine-auth-api-key
            - name: OCIS_TRANSFER_SECRET
              valueFrom:
                secretKeyRef:
                  name: owncloud-secrets
                  key: transfer-secret
            - name: OCIS_SYSTEM_USER_API_KEY
              valueFrom:
                secretKeyRef:
                  name: owncloud-secrets
                  key: system-user-api-key
            
            # ===================
            # OIDC Configuration (Pocket ID)
            # ===================
            # Disable built-in IDP - use external Pocket ID
            # Note: NATS must remain enabled - it's required for oCIS event messaging
            - name: OCIS_EXCLUDE_RUN_SERVICES
              value: "idp"
            
            # Proxy OIDC settings
            - name: PROXY_OIDC_ISSUER
              value: "https://auth.newjoy.ro"
            - name: PROXY_OIDC_REWRITE_WELLKNOWN
              value: "true"
            - name: PROXY_OIDC_ACCESS_TOKEN_VERIFY_METHOD
              value: "jwt"
            - name: PROXY_USER_OIDC_CLAIM
              value: "preferred_username"
            - name: PROXY_USER_CS3_CLAIM
              value: "username"
            - name: PROXY_AUTOPROVISION_ACCOUNTS
              value: "true"
            
            # Web OIDC settings (frontend)
            - name: WEB_OIDC_AUTHORITY
              value: "https://auth.newjoy.ro"
            - name: WEB_OIDC_CLIENT_ID
              valueFrom:
                secretKeyRef:
                  name: owncloud-oidc
                  key: client-id
            - name: WEB_OIDC_SCOPE
              value: "openid profile email"
            
            # CSP Configuration - allow external OIDC provider
            # This is required for the web frontend to connect to Pocket ID
            - name: PROXY_CSP_CONFIG_FILE_LOCATION
              value: "/etc/ocis/csp.yaml"
            
            # Identity backend
            - name: GRAPH_IDENTITY_BACKEND
              value: "ldap"
            - name: IDM_CREATE_DEMO_USERS
              value: "false"
            
            # ===================
            # Storage Configuration (Posix FS)
            # ===================
            - name: STORAGE_USERS_DRIVER
              value: "posix"
            - name: STORAGE_USERS_POSIX_ROOT
              value: "/var/lib/ocis/storage/users"
            - name: STORAGE_USERS_POSIX_PERMISSIONS_DRIVER
              value: "posixfs"
            # Watch for filesystem changes (for migration support)
            - name: STORAGE_USERS_POSIX_WATCH_TYPE
              value: "inotifywait"
            # Use space groups for file permissions
            - name: STORAGE_USERS_POSIX_USE_SPACE_GROUPS
              value: "true"
            
            # ===================
            # NATS Configuration (Event Messaging + ID Cache)
            # ===================
            # oCIS requires NATS for internal event messaging between services
            # Posix FS driver also requires nats-js-kv for ID cache (per docs)
            # Using the embedded NATS server, bound to 0.0.0.0 for collaboration sidecar
            - name: NATS_NATS_HOST
              value: "0.0.0.0"
            - name: NATS_NATS_PORT
              value: "9233"
            # Make gateway accessible to collaboration service
            - name: GATEWAY_GRPC_ADDR
              value: "0.0.0.0:9142"
            
            # ===================
            # ID Cache for Posix FS (required!)
            # ===================
            # Posix FS driver requires nats-js-kv for ID cache (not Redis!)
            # This is per ownCloud documentation for PosixFS driver
            - name: STORAGE_USERS_ID_CACHE_STORE
              value: "nats-js-kv"
            - name: STORAGE_USERS_ID_CACHE_STORE_NODES
              value: "127.0.0.1:9233"
            # Also configure for storage-system
            - name: STORAGE_SYSTEM_ID_CACHE_STORE
              value: "nats-js-kv"
            - name: STORAGE_SYSTEM_ID_CACHE_STORE_NODES
              value: "127.0.0.1:9233"
            
            # ===================
            # Thumbnail Configuration
            # ===================
            - name: THUMBNAILS_DATA_PATH
              value: "/var/lib/ocis/thumbnails"
            
            # ===================
            # Search Configuration
            # ===================
            # Full-text search via Apache Tika for content extraction
            # Reuses the Tika instance from paperless-ngx namespace
            # If Tika is unavailable, search still works but only on filenames
            - name: SEARCH_EXTRACTOR_TYPE
              value: "tika"
            # Note: SEARCH_EXTRACTOR_TIKA_TIKA_URL is the correct env var name
            # (SEARCH service, EXTRACTOR_TIKA subsection, TIKA_URL setting)
            - name: SEARCH_EXTRACTOR_TIKA_TIKA_URL
              value: "http://tika.paperless-ngx.svc.cluster.local:9998"
            - name: SEARCH_INDEX_DIR
              value: "/var/lib/ocis/search"
            
            # ===================
            # Email Notifications (via Stalwart relay)
            # ===================
            - name: NOTIFICATIONS_SMTP_HOST
              value: "stalwart.stalwart-mail.svc.cluster.local"
            - name: NOTIFICATIONS_SMTP_PORT
              value: "25"
            - name: NOTIFICATIONS_SMTP_SENDER
              valueFrom:
                secretKeyRef:
                  name: owncloud-email
                  key: from-address
            - name: NOTIFICATIONS_SMTP_INSECURE
              value: "true"  # Internal traffic, no TLS needed
            
            # ===================
            # App Registry Configuration
            # ===================
            - name: APP_REGISTRY_CONFIG_FILE
              value: "/etc/ocis/app-registry.yaml"
          
          volumeMounts:
            - name: data
              mountPath: /var/lib/ocis/storage
            - name: config
              mountPath: /etc/ocis
            - name: csp-config
              mountPath: /etc/ocis/csp.yaml
              subPath: csp.yaml
            - name: app-registry-config
              mountPath: /etc/ocis/app-registry.yaml
              subPath: app-registry.yaml
            - name: thumbnails
              mountPath: /var/lib/ocis/thumbnails
            - name: search
              mountPath: /var/lib/ocis/search
          
          resources:
            requests:
              cpu: 200m
              memory: 512Mi
            limits:
              cpu: 2000m
              memory: 2Gi
          
          # Startup probe - allows up to 5 minutes for initial startup
          startupProbe:
            httpGet:
              path: /healthz
              port: https
            failureThreshold: 30
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /healthz
              port: https
            periodSeconds: 30
            timeoutSeconds: 10
          readinessProbe:
            httpGet:
              path: /healthz
              port: https
            periodSeconds: 10
            timeoutSeconds: 5
        
        # ===================
        # Collaboration Service (OnlyOffice WOPI)
        # ===================
        # This sidecar runs the collaboration service that bridges oCIS and OnlyOffice
        - name: collaboration
          image: owncloud/ocis:7.0.0
          command: ["ocis", "collaboration", "server"]
          ports:
            - containerPort: 9300
              name: wopi-http
            - containerPort: 9301
              name: wopi-grpc
          env:
            # Service addresses
            - name: COLLABORATION_GRPC_ADDR
              value: "0.0.0.0:9301"
            - name: COLLABORATION_HTTP_ADDR
              value: "0.0.0.0:9300"
            
            # Connect to main oCIS NATS for service registry
            - name: MICRO_REGISTRY
              value: "nats-js-kv"
            - name: MICRO_REGISTRY_ADDRESS
              value: "127.0.0.1:9233"
            
            # WOPI configuration
            - name: COLLABORATION_WOPI_SRC
              value: "https://drive.newjoy.ro"
            - name: COLLABORATION_APP_NAME
              value: "OnlyOffice"
            - name: COLLABORATION_APP_PRODUCT
              value: "OnlyOffice"
            - name: COLLABORATION_APP_ADDR
              value: "http://onlyoffice:80"
            - name: COLLABORATION_APP_ICON
              value: "https://drive.newjoy.ro/web-apps/apps/documenteditor/main/resources/img/favicon.ico"
            - name: COLLABORATION_APP_INSECURE
              value: "true"
            - name: COLLABORATION_CS3API_DATAGATEWAY_INSECURE
              value: "true"
            
            # oCIS URL for callbacks
            - name: OCIS_URL
              value: "https://drive.newjoy.ro"
            
            # Logging
            - name: COLLABORATION_LOG_LEVEL
              value: "info"
            
            # Shared secrets (must match main container)
            - name: OCIS_JWT_SECRET
              valueFrom:
                secretKeyRef:
                  name: owncloud-secrets
                  key: jwt-secret
            - name: OCIS_MACHINE_AUTH_API_KEY
              valueFrom:
                secretKeyRef:
                  name: owncloud-secrets
                  key: machine-auth-api-key
          
          volumeMounts:
            - name: config
              mountPath: /etc/ocis
          
          resources:
            requests:
              cpu: 50m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 512Mi
          
          # Simple TCP check for WOPI HTTP endpoint
          readinessProbe:
            tcpSocket:
              port: wopi-http
            periodSeconds: 10
            timeoutSeconds: 5
          livenessProbe:
            tcpSocket:
              port: wopi-http
            periodSeconds: 30
            timeoutSeconds: 10
      
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: owncloud-data
        - name: config
          persistentVolumeClaim:
            claimName: owncloud-config
        - name: csp-config
          configMap:
            name: owncloud-config
        - name: app-registry-config
          configMap:
            name: owncloud-config
        - name: thumbnails
          persistentVolumeClaim:
            claimName: owncloud-thumbnails
        - name: search
          persistentVolumeClaim:
            claimName: owncloud-search
---
apiVersion: v1
kind: Service
metadata:
  name: owncloud
  namespace: owncloud
  labels:
    app: owncloud
  annotations:
    argocd.argoproj.io/sync-wave: "2"
spec:
  type: ClusterIP
  selector:
    app: owncloud
  ports:
    - name: https
      port: 9200
      targetPort: 9200
      protocol: TCP
    - name: wopi-http
      port: 9300
      targetPort: 9300
      protocol: TCP
    - name: wopi-grpc
      port: 9301
      targetPort: 9301
      protocol: TCP

