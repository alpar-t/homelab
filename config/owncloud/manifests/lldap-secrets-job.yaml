# Job to generate LLDAP secrets if they don't exist
apiVersion: batch/v1
kind: Job
metadata:
  name: lldap-secrets-init
  namespace: owncloud
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      serviceAccountName: lldap-secrets-sa
      restartPolicy: OnFailure
      containers:
        - name: init-secrets
          image: bitnami/kubectl:latest
          command:
            - /bin/bash
            - -c
            - |
              set -e
              
              # Check if secret already exists with real values
              EXISTING=$(kubectl get secret lldap-secrets -n owncloud -o jsonpath='{.data.LLDAP_LDAP_USER_PASS}' 2>/dev/null | base64 -d || echo "")
              if [ -n "$EXISTING" ] && [ "$EXISTING" != "CHANGE_ME_ON_FIRST_DEPLOY" ]; then
                echo "Secret already exists with real values, skipping..."
                exit 0
              fi
              
              echo "Generating new LLDAP secrets..."
              
              # Generate random passwords
              LDAP_PASS=$(openssl rand -base64 24 | tr -d '/+=' | head -c 32)
              JWT_SECRET=$(openssl rand -base64 32 | tr -d '/+=' | head -c 48)
              
              # Create the secret with all required keys
              kubectl create secret generic lldap-secrets \
                --namespace owncloud \
                --from-literal=LLDAP_LDAP_USER_PASS="$LDAP_PASS" \
                --from-literal=LLDAP_JWT_SECRET="$JWT_SECRET" \
                --from-literal=reva-ldap-bind-password="$LDAP_PASS" \
                --dry-run=client -o yaml | kubectl apply -f -
              
              echo "LLDAP secrets generated successfully"
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: lldap-secrets-sa
  namespace: owncloud
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: lldap-secrets-role
  namespace: owncloud
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "create", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: lldap-secrets-rolebinding
  namespace: owncloud
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
subjects:
  - kind: ServiceAccount
    name: lldap-secrets-sa
    namespace: owncloud
roleRef:
  kind: Role
  name: lldap-secrets-role
  apiGroup: rbac.authorization.k8s.io

