---
# Source: ocis/templates/notifications/jobs.yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: notifications-weekly-notifications
  namespace: owncloud
  labels:
    helm.sh/chart: ocis-0.7.0
    app.kubernetes.io/name: ocis
    app.kubernetes.io/instance: ocis
    app.kubernetes.io/version: "7.1.4"
    app.kubernetes.io/managed-by: Helm
spec:
  schedule: "0 0 * * 0"
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  startingDeadlineSeconds: 600
  suspend: true
  jobTemplate:
    spec:
      parallelism: 1
      ttlSecondsAfterFinished: 86400
      template:
        metadata:
          labels:
            app: notifications-weekly-notifications
            helm.sh/chart: ocis-0.7.0
            app.kubernetes.io/name: ocis
            app.kubernetes.io/instance: ocis
            app.kubernetes.io/version: "7.1.4"
            app.kubernetes.io/managed-by: Helm
        spec:
          restartPolicy: Never
          securityContext:
              fsGroup: 1000
              fsGroupChangePolicy: Always
          
          
          nodeSelector: 
            {}
          containers:
            - name: notifications-weekly-notifications
              image: "owncloud/ocis:7.1.4"
              imagePullPolicy: IfNotPresent
              command: ["ocis"]
              args: ["notifications", "send-email", "--weekly"]
              securityContext:
                runAsNonRoot: true
                runAsUser: 1000
                runAsGroup: 1000
                readOnlyRootFilesystem: true
              env:
                - name: MICRO_REGISTRY
                  value: "nats-js-kv"
                - name: MICRO_REGISTRY_ADDRESS
                  value: "nats:9233"
                
                - name: OCIS_EVENTS_ENDPOINT
                  value: nats:9233
                # logging
                - name: NOTIFICATIONS_LOG_COLOR
                  value: "false"
                - name: NOTIFICATIONS_LOG_LEVEL
                  value: "info"
                - name: NOTIFICATIONS_PRETTY
                  value: "false"

                - name: NOTIFICATIONS_SMTP_SENDER #TODO: only needed to satisfy config checks!?
                  value: "ownCloud <service@newjoy.ro>"

              resources: 
                {}

              volumeMounts:
                - name: tmp-volume
                  mountPath: /tmp
                - name: messaging-system-ca
                  mountPath: /etc/ocis/messaging-system-ca
                  readOnly: true
                
          
          volumes:
            - name: tmp-volume
              emptyDir: {}
            - name: messaging-system-ca
              
              emptyDir: {}
