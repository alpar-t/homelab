---
# Source: ocis/templates/storageusers/jobs.yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: storage-users-clean-expired-uploads
  namespace: owncloud
  labels:
    helm.sh/chart: ocis-0.7.0
    app.kubernetes.io/name: ocis
    app.kubernetes.io/instance: ocis
    app.kubernetes.io/version: "7.1.4"
    app.kubernetes.io/managed-by: Helm
spec:
  schedule: "0 * * * *"
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  startingDeadlineSeconds: 600
  suspend: true
  jobTemplate:
    spec:
      parallelism: 1
      ttlSecondsAfterFinished: 86400
      template:
        metadata:
          labels:
            app: storage-users-clean-expired-uploads
            helm.sh/chart: ocis-0.7.0
            app.kubernetes.io/name: ocis
            app.kubernetes.io/instance: ocis
            app.kubernetes.io/version: "7.1.4"
            app.kubernetes.io/managed-by: Helm
        spec:
          restartPolicy: Never
          securityContext:
              fsGroup: 1000
              fsGroupChangePolicy: Always
          
          
          nodeSelector: 
            {}
          containers:
            - name: storage-users-clean-expired-uploads
              image: "owncloud/ocis:7.1.4"
              imagePullPolicy: IfNotPresent
              command: ["ocis"]
              args: ["storage-users", "uploads", "sessions", "--clean", "--expired", "--processing=false"]
              securityContext:
                runAsNonRoot: true
                runAsUser: 1000
                runAsGroup: 1000
                readOnlyRootFilesystem: true
              env:
                - name: MICRO_REGISTRY
                  value: "nats-js-kv"
                - name: MICRO_REGISTRY_ADDRESS
                  value: "nats:9233"
                # logging
                - name: STORAGE_USERS_LOG_COLOR
                  value: "false"
                - name: STORAGE_USERS_LOG_LEVEL
                  value: "info"
                - name: STORAGE_USERS_LOG_PRETTY
                  value: "false"

                # oCIS storage driver (decomposed filesystem)
                - name: STORAGE_USERS_DRIVER
                  value: ocis

                # S3ng storage driver (decomposed filesystem)

                - name: STORAGE_USERS_JWT_SECRET
                  valueFrom:
                    secretKeyRef:
                      name: "jwt-secret"
                      key: jwt-secret

                - name: OCIS_TRANSFER_SECRET
                  valueFrom:
                    secretKeyRef:
                      name: "transfer-secret"
                      key: transfer-secret

                - name: STORAGE_USERS_MOUNT_ID
                  valueFrom:
                    configMapKeyRef:
                      name: "storage-users"
                      key: storage-uuid

                - name: STORAGE_USERS_SERVICE_ACCOUNT_ID
                  valueFrom:
                    configMapKeyRef:
                      name: "auth-service"
                      key: service-account-id
                - name: STORAGE_USERS_SERVICE_ACCOUNT_SECRET
                  valueFrom:
                    secretKeyRef:
                      name: "service-account-secret"
                      key: service-account-secret
                

              resources: 
                {}

              volumeMounts:
                - name: tmp-volume
                  mountPath: /tmp
                - name: storageusers-data
                  mountPath: /var/lib/ocis
                
          
          volumes:
            - name: tmp-volume
              emptyDir: {}
            - name: storageusers-data
              persistentVolumeClaim:
                claimName: storageusers-data
