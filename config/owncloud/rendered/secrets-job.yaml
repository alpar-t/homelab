---
# RBAC for secrets generation
apiVersion: v1
kind: ServiceAccount
metadata:
  name: ocis-secrets-sa
  namespace: owncloud
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: ocis-secrets-role
  namespace: owncloud
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "create", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: ocis-secrets-rolebinding
  namespace: owncloud
subjects:
  - kind: ServiceAccount
    name: ocis-secrets-sa
    namespace: owncloud
roleRef:
  kind: Role
  name: ocis-secrets-role
  apiGroup: rbac.authorization.k8s.io
---
# Job to generate all oCIS secrets if they don't exist
apiVersion: batch/v1
kind: Job
metadata:
  name: ocis-secrets-init
  namespace: owncloud
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      serviceAccountName: ocis-secrets-sa
      restartPolicy: OnFailure
      containers:
        - name: secrets-init
          image: bitnami/kubectl:latest
          command:
            - /bin/bash
            - -c
            - |
              set -e
              
              # Function to generate random string
              random_string() {
                openssl rand -base64 32 | tr -d '/+=' | head -c "$1"
              }
              
              # Function to generate UUID
              random_uuid() {
                cat /proc/sys/kernel/random/uuid
              }
              
              # Function to create secret if not exists
              create_secret_if_missing() {
                local name="$1"
                shift
                if kubectl get secret "$name" -n owncloud >/dev/null 2>&1; then
                  echo "Secret $name already exists, skipping"
                  return 0
                fi
                echo "Creating secret $name..."
                kubectl create secret generic "$name" -n owncloud "$@"
              }
              
              echo "=== Generating oCIS secrets ==="
              
              # 1. machine-auth-api-key
              create_secret_if_missing "machine-auth-api-key" \
                --from-literal=machine-auth-api-key="$(random_string 32)"
              
              # 2. service-account-secret
              create_secret_if_missing "service-account-secret" \
                --from-literal=service-account-secret="$(random_string 32)"
              
              # 3. collaboration-wopi-secret
              create_secret_if_missing "collaboration-wopi-secret" \
                --from-literal=wopi-secret="$(random_string 32)"
              
              # 4. jwt-secret
              create_secret_if_missing "jwt-secret" \
                --from-literal=jwt-secret="$(random_string 32)"
              
              # 5. storage-system-jwt-secret
              create_secret_if_missing "storage-system-jwt-secret" \
                --from-literal=storage-system-jwt-secret="$(random_string 32)"
              
              # 6. transfer-secret
              create_secret_if_missing "transfer-secret" \
                --from-literal=transfer-secret="$(random_string 32)"
              
              # 7. thumbnails-transfer-secret
              create_secret_if_missing "thumbnails-transfer-secret" \
                --from-literal=thumbnails-transfer-secret="$(random_string 32)"
              
              # 8. storage-system (api-key + user-id)
              create_secret_if_missing "storage-system" \
                --from-literal=api-key="$(random_string 32)" \
                --from-literal=user-id="$(random_uuid)"
              
              # 9. admin-user
              ADMIN_PASS=$(random_string 24)
              create_secret_if_missing "admin-user" \
                --from-literal=user-id="$(random_uuid)" \
                --from-literal=password="$ADMIN_PASS"
              
              # 10. ldap-bind-secrets (3 passwords for graph, idp, reva)
              LDAP_PASS=$(random_string 32)
              create_secret_if_missing "ldap-bind-secrets" \
                --from-literal=graph-ldap-bind-password="$LDAP_PASS" \
                --from-literal=idp-ldap-bind-password="$LDAP_PASS" \
                --from-literal=reva-ldap-bind-password="$LDAP_PASS"
              
              # 11. Generate LDAP CA certificate
              if ! kubectl get secret ldap-ca -n owncloud >/dev/null 2>&1; then
                echo "Generating LDAP CA certificate..."
                cd /tmp
                openssl genrsa -out ca.key 4096
                openssl req -x509 -new -nodes -key ca.key -sha256 -days 3650 \
                  -out ca.crt -subj "/CN=ocis-ldap-ca"
                kubectl create secret generic ldap-ca -n owncloud \
                  --from-file=ldap-ca.crt=ca.crt
              else
                echo "Secret ldap-ca already exists, skipping"
              fi
              
              # 12. Generate LDAP server certificate
              if ! kubectl get secret ldap-cert -n owncloud >/dev/null 2>&1; then
                echo "Generating LDAP server certificate..."
                cd /tmp
                # Get CA if we didn't just create it
                if [ ! -f ca.key ]; then
                  kubectl get secret ldap-ca -n owncloud -o jsonpath='{.data.ldap-ca\.crt}' | base64 -d > ca.crt
                  # We can't sign without CA key, so generate new CA
                  openssl genrsa -out ca.key 4096
                  openssl req -x509 -new -nodes -key ca.key -sha256 -days 3650 \
                    -out ca.crt -subj "/CN=ocis-ldap-ca"
                  kubectl create secret generic ldap-ca -n owncloud \
                    --from-file=ldap-ca.crt=ca.crt --dry-run=client -o yaml | kubectl apply -f -
                fi
                openssl genrsa -out ldap.key 4096
                openssl req -new -key ldap.key -out ldap.csr -subj "/CN=idm"
                cat > ldap-ext.cnf << EOF
              authorityKeyIdentifier=keyid,issuer
              basicConstraints=CA:FALSE
              keyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment
              subjectAltName = DNS:idm, DNS:idm.owncloud.svc.cluster.local
              EOF
                openssl x509 -req -in ldap.csr -CA ca.crt -CAkey ca.key -CAcreateserial \
                  -out ldap.crt -days 3650 -sha256 -extfile ldap-ext.cnf
                kubectl create secret generic ldap-cert -n owncloud \
                  --from-file=ldap.crt=ldap.crt \
                  --from-file=ldap.key=ldap.key
              else
                echo "Secret ldap-cert already exists, skipping"
              fi
              
              # 13. IDP secrets (signing key + encryption key)
              if ! kubectl get secret idp-secrets -n owncloud >/dev/null 2>&1; then
                echo "Generating IDP secrets..."
                cd /tmp
                openssl genrsa -out private-key.pem 4096
                openssl rand -out encryption.key 32
                kubectl create secret generic idp-secrets -n owncloud \
                  --from-file=private-key.pem=private-key.pem \
                  --from-file=encryption.key=encryption.key
              else
                echo "Secret idp-secrets already exists, skipping"
              fi
              
              echo "=== All secrets generated ==="

