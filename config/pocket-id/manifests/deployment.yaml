apiVersion: apps/v1
kind: Deployment
metadata:
  name: pocket-id
  namespace: pocket-id
  labels:
    app: pocket-id
spec:
  # Temporarily set to 1 until session handling is fixed for HA
  replicas: 1
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
      maxSurge: 1
  selector:
    matchLabels:
      app: pocket-id
  template:
    metadata:
      labels:
        app: pocket-id
    spec:
      # Spread across nodes for HA
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    app: pocket-id
                topologyKey: kubernetes.io/hostname
      containers:
        - name: pocket-id
          image: ghcr.io/pocket-id/pocket-id:v1
          ports:
            - containerPort: 1411
              name: http
          env:
            - name: APP_URL
              value: "https://auth.newjoy.ro"
            - name: TRUST_PROXY
              value: "true"
            # Database configuration
            - name: DB_PROVIDER
              value: "postgres"
            - name: DB_CONNECTION_STRING
              valueFrom:
                secretKeyRef:
                  name: pocket-id-db-app
                  key: uri
            # Encryption key for passkeys/secrets
            - name: ENCRYPTION_KEY
              valueFrom:
                secretKeyRef:
                  name: pocket-id-secrets
                  key: encryption_key
            # Disable UI config so env vars take effect for SMTP and app settings
            # OIDC clients/users can still be managed via UI
            - name: UI_CONFIG_DISABLED
              value: "true"
            # Application name shown in UI and emails
            - name: APP_NAME
              value: "NewJoy ID"
            # Accent color (teal)
            - name: UI_CONFIG
              value: '{"theme": {"accentColor": "#008080"}}'
            # Session duration in minutes (24 hours - balance of security and convenience)
            - name: SESSION_DURATION
              value: "1440"
            # Email notification when login from new device
            - name: EMAIL_LOGIN_NOTIFICATION_ENABLED
              value: "true"
            # Email configuration - uses Stalwart as local relay (no auth needed on port 25)
            - name: SMTP_HOST
              value: "stalwart.stalwart-mail.svc.cluster.local"
            - name: SMTP_PORT
              value: "25"
            - name: SMTP_FROM
              value: "auth@newjoy.ro"
            # Valid values: none, starttls, tls
            - name: SMTP_TLS
              value: "none"
            # App dashboard
            - name: APP_DASHBOARD_ENABLED
              value: "true"
          resources:
            requests:
              cpu: 25m
              memory: 64Mi
            limits:
              cpu: 200m
              memory: 128Mi
          livenessProbe:
            httpGet:
              path: /healthz
              port: http
            initialDelaySeconds: 10
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /healthz
              port: http
            initialDelaySeconds: 5
            periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: pocket-id
  namespace: pocket-id
  labels:
    app: pocket-id
spec:
  type: ClusterIP
  selector:
    app: pocket-id
  ports:
    - name: http
      port: 80
      targetPort: 1411
      protocol: TCP
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: pocket-id
  namespace: pocket-id
spec:
  ingressClassName: nginx
  rules:
    - host: auth.newjoy.ro
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: pocket-id
                port:
                  number: 80

