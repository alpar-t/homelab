apiVersion: v1
kind: ServiceAccount
metadata:
  name: pocket-id-secrets-generator
  namespace: pocket-id
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: pocket-id-secrets-generator
  namespace: pocket-id
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "create"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: pocket-id-secrets-generator
  namespace: pocket-id
subjects:
  - kind: ServiceAccount
    name: pocket-id-secrets-generator
    namespace: pocket-id
roleRef:
  kind: Role
  name: pocket-id-secrets-generator
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: batch/v1
kind: Job
metadata:
  name: pocket-id-secrets-generator
  namespace: pocket-id
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  template:
    spec:
      serviceAccountName: pocket-id-secrets-generator
      restartPolicy: OnFailure
      containers:
        - name: generate-secrets
          image: bitnami/kubectl:latest@sha256:b349e60a6ae2969af84a778c0b976b050a0cc77f4fb6a4ad44307cd0a06e9d8f
          command:
            - /bin/bash
            - -c
            - |
              set -e
              
              # Check if secret already exists
              if kubectl get secret pocket-id-secrets -n pocket-id >/dev/null 2>&1; then
                echo "Secret 'pocket-id-secrets' already exists, skipping generation"
                exit 0
              fi
              
              echo "Generating Pocket-ID secrets..."
              
              # Generate encryption key (base64-encoded random bytes)
              ENCRYPTION_KEY=$(head -c 32 /dev/urandom | base64)
              
              # Create the secret
              kubectl create secret generic pocket-id-secrets \
                --namespace=pocket-id \
                --from-literal=encryption_key="$ENCRYPTION_KEY"
              
              echo "Secret 'pocket-id-secrets' created successfully"

