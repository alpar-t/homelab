apiVersion: v1
kind: ConfigMap
metadata:
  name: roundcube-config
  namespace: roundcube
  labels:
    app: roundcube
data:
  # Additional Roundcube configuration
  # Mounted to /var/roundcube/config/custom.inc.php
  custom.inc.php: |
    <?php
    // Custom Roundcube configuration
    
    // Product name shown in UI
    $config['product_name'] = 'Newjoy Mail';
    
    // Session lifetime in minutes
    $config['session_lifetime'] = 60;
    
    // Enable plugins
    $config['plugins'] = ['archive', 'zipdownload', 'managesieve'];
    
    // Force email domain for identities (instead of IMAP server hostname)
    $config['mail_domain'] = 'newjoy.ro';
    
    // SMTP configuration - disable authentication (internal relay)
    $config['smtp_server'] = 'stalwart.stalwart-mail.svc.cluster.local';
    $config['smtp_port'] = 25;
    $config['smtp_user'] = '';
    $config['smtp_pass'] = '';
    
    // HTTP Basic Auth auto-login via http_authentication plugin
    // nginx passes Authorization header, Apache converts to PHP_AUTH_*
    $config['plugins'][] = 'http_authentication';
    
    // http_authentication plugin settings
    $config['http_authentication_host'] = 'stalwart.stalwart-mail.svc.cluster.local';
    
    // Logout settings  
    $config['logout_purge'] = false;
    $config['logout_expunge'] = false;
    
    // Auto-create user on first login
    $config['auto_create_user'] = true;
  # Apache config to pass Authorization header to PHP
  # This is needed for http_authentication plugin to work
  htaccess: |
    # Pass HTTP Authorization header to PHP for http_authentication plugin
    SetEnvIf Authorization "(.*)" HTTP_AUTHORIZATION=$1
    RewriteEngine On
    RewriteCond %{HTTP:Authorization} ^(.*)
    RewriteRule .* - [E=HTTP_AUTHORIZATION:%1]
