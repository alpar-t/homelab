apiVersion: v1
kind: ConfigMap
metadata:
  name: roundcube-config
  namespace: roundcube
  labels:
    app: roundcube
data:
  # Additional Roundcube configuration
  # Mounted to /var/roundcube/config/custom.inc.php
  custom.inc.php: |
    <?php
    // Custom Roundcube configuration
    
    // Product name shown in UI
    $config['product_name'] = 'Newjoy Mail';
    
    // Session lifetime in minutes
    $config['session_lifetime'] = 60;
    
    // Enable plugins
    $config['plugins'] = ['archive', 'zipdownload', 'managesieve'];
    
    // Force email domain for identities (instead of IMAP server hostname)
    $config['mail_domain'] = 'newjoy.ro';
    
    // IMAP server - Stalwart (internal, no TLS)
    $config['default_host'] = 'stalwart.stalwart-mail.svc.cluster.local';
    $config['default_port'] = 143;
    $config['imap_auth_type'] = 'OAUTHBEARER';
    
    // SMTP configuration - Stalwart with OAUTHBEARER
    $config['smtp_server'] = 'stalwart.stalwart-mail.svc.cluster.local';
    $config['smtp_port'] = 587;
    $config['smtp_auth_type'] = 'OAUTHBEARER';
    
    // OAuth2 configuration - Pocket ID
    $config['oauth_provider'] = 'generic';
    $config['oauth_provider_name'] = 'Pocket ID';
    $config['oauth_client_id'] = getenv('OAUTH_CLIENT_ID');
    $config['oauth_client_secret'] = getenv('OAUTH_CLIENT_SECRET');
    // Use OIDC discovery for endpoints
    $config['oauth_config_uri'] = 'https://auth.newjoy.ro/.well-known/openid-configuration';
    $config['oauth_scope'] = 'openid email profile';
    
    // Map email field from identity response (without @domain for Stalwart username)
    $config['oauth_identity_fields'] = ['preferred_username', 'email'];
    
    // Redirect directly to OAuth login (skip username/password form)
    $config['oauth_login_redirect'] = true;
    
    // Required for reverse proxy setup
    $config['use_https'] = true;
    
    // Logout settings
    $config['logout_purge'] = false;
    $config['logout_expunge'] = false;
    
    // Auto-create user on first login
    $config['auto_create_user'] = true;
