apiVersion: v1
kind: ConfigMap
metadata:
  name: stalwart-config
  namespace: stalwart-mail
  labels:
    app: stalwart
data:
  # Stalwart configuration - TOML format
  # See https://stalw.art/docs/configuration/overview
  config.toml: |
    [tracer."stdout"]
    type = "stdout"
    level = "info"
    ansi = false
    enable = true
    
    [server]
    hostname = "mail.newjoy.ro"
    
    [server.listener.smtp]
    bind = ["[::]:25"]
    protocol = "smtp"
    
    # Allow relay from internal cluster (port 25 listener)
    # Any mail received on port 25 is allowed to relay (internal services only)
    [session.rcpt]
    relay = true
    
    [server.listener.submissions]
    bind = ["[::]:587"]
    protocol = "smtp"
    tls.implicit = false
    
    [server.listener.imaps]
    bind = ["[::]:993"]
    protocol = "imap"
    tls.implicit = true
    
    [server.listener.imap]
    bind = ["[::]:143"]
    protocol = "imap"
    tls.implicit = false
    
    [server.listener.https]
    bind = ["[::]:8080"]
    protocol = "http"
    
    [storage]
    data = "postgresql"
    fts = "postgresql"
    blob = "filesystem"
    lookup = "postgresql"
    directory = "internal"
    
    [store.postgresql]
    type = "postgresql"
    host = "stalwart-db-rw.stalwart-mail.svc.cluster.local"
    port = 5432
    database = "stalwart"
    user = "stalwart"
    password = "%{env:DB_PASSWORD}%"
    timeout = "15s"
    max-connections = 10
    
    [store.filesystem]
    type = "fs"
    path = "/opt/stalwart/blobs"
    
    [directory.internal]
    type = "internal"
    store = "postgresql"
    
    [authentication]
    fallback-admin.user = "admin"
    fallback-admin.secret = "%{env:ADMIN_PASSWORD}%"
    
    [oauth]
    oidc.enable = true
    oidc.issuer-url = "https://auth.newjoy.ro"
    oidc.client-id = "%{env:OIDC_CLIENT_ID}%"
    oidc.client-secret = "%{env:OIDC_CLIENT_SECRET}%"
    oidc.scopes = ["openid", "email", "profile"]
    oidc.auto-create = true
    
    [oauth.claims]
    email = "email"
    name = "name"
    
    # Outbound mail relay through Migadu
    [remote."migadu"]
    protocol = "smtp"
    address = "smtp.migadu.com"
    port = 465
    tls.implicit = true
    auth.enable = true
    auth.username = "%{env:MIGADU_SMTP_USERNAME}%"
    auth.secret = "%{env:MIGADU_SMTP_PASSWORD}%"
    
    [queue.outbound.next-hop]
    default = "migadu"

