apiVersion: v1
kind: ConfigMap
metadata:
  name: stalwart-config
  namespace: stalwart-mail
  labels:
    app: stalwart
data:
  # Stalwart configuration - TOML format
  # See https://stalw.art/docs/configuration/overview
  config.toml: |
    # Force these settings to be read from local config file, not database
    # See: https://stalw.art/docs/configuration/overview/#local-and-database-settings
    [config]
    local-keys = [ "store.*", "directory.*", "tracer.*", "server.*", 
                   "authentication.fallback-admin.*", "cluster.*", "config.local-keys.*",
                   "storage.*", "certificate.*",
                   # Custom additions for our setup:
                   "oauth.*", "session.*", "queue.*", "spam-filter.*" ]
    
    [tracer."stdout"]
    type = "stdout"
    level = "info"
    ansi = false
    enable = true
    
    [server]
    hostname = "mail.newjoy.ro"
    
    [server.listener.smtp]
    bind = ["[::]:25"]
    protocol = "smtp"
    
    # Allow relay from internal cluster (port 25 listener)
    # Any mail received on port 25 is allowed to relay (internal services only)
    [session.rcpt]
    relay = true
    
    # Disable spam filter headers for relayed mail
    # These headers (X-Spam-Status, X-Spam-Result) can cause external
    # receivers like Gmail to flag messages as spam
    # See: https://stalw.art/docs/spamfilter/settings/general/
    [spam-filter.header.status]
    enable = false
    
    [spam-filter.header.result]
    enable = false
    
    [server.listener.submissions]
    bind = ["[::]:587"]
    protocol = "smtp"
    tls.implicit = false
    
    [server.listener.imaps]
    bind = ["[::]:993"]
    protocol = "imap"
    tls.implicit = true
    
    [server.listener.imap]
    bind = ["[::]:143"]
    protocol = "imap"
    tls.implicit = false
    
    [server.listener.https]
    bind = ["[::]:8080"]
    protocol = "http"
    
    [storage]
    data = "postgresql"
    fts = "postgresql"
    blob = "filesystem"
    lookup = "postgresql"
    directory = "internal"
    
    [store.postgresql]
    type = "postgresql"
    host = "stalwart-db-rw.stalwart-mail.svc.cluster.local"
    port = 5432
    database = "stalwart"
    user = "stalwart"
    password = "%{env:DB_PASSWORD}%"
    timeout = "15s"
    max-connections = 10
    
    [store.filesystem]
    type = "fs"
    path = "/opt/stalwart/blobs"
    
    [directory.internal]
    type = "internal"
    store = "postgresql"
    
    [authentication]
    fallback-admin.user = "admin"
    fallback-admin.secret = "%{env:ADMIN_PASSWORD}%"
    
    [oauth]
    oidc.enable = true
    oidc.issuer-url = "https://auth.newjoy.ro"
    oidc.client-id = "%{env:OIDC_CLIENT_ID}%"
    oidc.client-secret = "%{env:OIDC_CLIENT_SECRET}%"
    oidc.scopes = ["openid", "email", "profile"]
    oidc.auto-create = true
    
    [oauth.claims]
    email = "email"
    name = "name"
    
    # Outbound mail routing strategy
    # Local domains delivered locally, everything else relayed through Migadu
    [queue.strategy]
    route = [ { if = "is_local_domain('', rcpt_domain)", then = "'local'" },
              { else = "'migadu'" } ]
    
    # Local delivery route
    [queue.route."local"]
    type = "local"
    
    # Migadu relay route for external delivery
    [queue.route."migadu"]
    type = "relay"
    address = "smtp.migadu.com"
    port = 465
    protocol = "smtp"
    
    [queue.route."migadu".tls]
    implicit = true
    allow-invalid-certs = false
    
    [queue.route."migadu".auth]
    username = "%{env:MIGADU_SMTP_USERNAME}%"
    secret = "%{env:MIGADU_SMTP_PASSWORD}%"

