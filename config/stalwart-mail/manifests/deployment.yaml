apiVersion: apps/v1
kind: Deployment
metadata:
  name: stalwart
  namespace: stalwart-mail
  labels:
    app: stalwart
  annotations:
    reloader.stakater.com/auto: "true"
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: stalwart
  template:
    metadata:
      labels:
        app: stalwart
    spec:
      initContainers:
        # Init container to substitute secrets into fetchmail config
        - name: fetchmail-config-init
          image: alpine:3.21@sha256:5405e8f36ce1878720f71217d664aa3dea32e5e5df11acbf07fc78ef5661465b
          command:
            - sh
            - -c
            - |
              apk add --no-cache gettext > /dev/null
              # Use envsubst for safe variable substitution (no special char issues)
              envsubst < /config-template/fetchmailrc.template > /config/fetchmailrc
              chmod 600 /config/fetchmailrc
              chown 1000:1000 /config/fetchmailrc
              echo "Fetchmail config generated:"
              cat /config/fetchmailrc | grep -v password
          envFrom:
            - secretRef:
                name: migadu-fetch-credentials
            - secretRef:
                name: stalwart-emails
          volumeMounts:
            - name: fetchmail-config-template
              mountPath: /config-template
            - name: fetchmail-config
              mountPath: /config
      containers:
        # Main Stalwart container
        - name: stalwart
          # Pinned version - see /CLOUD.md for update instructions
          image: stalwartlabs/stalwart:v0.13.2@sha256:e682677f83ebb44632e41684db293fd46db8ff94487cef3b894b5c668b448716
          args:
            - --config
            - /opt/stalwart/etc/config.toml
          ports:
            - containerPort: 25
              name: smtp
            - containerPort: 587
              name: submission
            - containerPort: 993
              name: imaps
            - containerPort: 143
              name: imap
            - containerPort: 8080
              name: http
          env:
            - name: ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: stalwart-admin
                  key: password
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: stalwart-db-app
                  key: password
            - name: OIDC_CLIENT_ID
              valueFrom:
                secretKeyRef:
                  name: stalwart-oidc
                  key: client_id
            - name: OIDC_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: stalwart-oidc
                  key: client_secret
            # Master user password for accessing any mailbox
            - name: MASTER_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: stalwart-master
                  key: password
            # Migadu SMTP credentials for outbound relay
            - name: MIGADU_SMTP_USERNAME
              valueFrom:
                secretKeyRef:
                  name: migadu-smtp-credentials
                  key: username
            - name: MIGADU_SMTP_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: migadu-smtp-credentials
                  key: password
          resources:
            requests:
              cpu: 50m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 512Mi
          livenessProbe:
            httpGet:
              path: /healthz/live
              port: http
            initialDelaySeconds: 30
            periodSeconds: 30
            timeoutSeconds: 10
          readinessProbe:
            httpGet:
              path: /healthz/ready
              port: http
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5
          volumeMounts:
            - name: stalwart-blobs
              mountPath: /opt/stalwart/blobs
            - name: stalwart-config
              mountPath: /opt/stalwart/etc
        # Fetchmail sidecar - pulls mail from Migadu
        - name: fetchmail
          image: alpine:3.21@sha256:5405e8f36ce1878720f71217d664aa3dea32e5e5df11acbf07fc78ef5661465b
          command:
            - sh
            - -c
            - |
              apk add --no-cache fetchmail
              # Copy config to writable location with correct permissions
              cp /config/fetchmailrc /tmp/fetchmailrc
              chmod 600 /tmp/fetchmailrc
              echo "Starting fetchmail daemon..."
              exec fetchmail -f /tmp/fetchmailrc -v --nodetach
          resources:
            requests:
              cpu: 10m
              memory: 32Mi
            limits:
              cpu: 100m
              memory: 64Mi
          volumeMounts:
            - name: fetchmail-config
              mountPath: /config
              readOnly: true
      volumes:
        - name: stalwart-blobs
          persistentVolumeClaim:
            claimName: stalwart-blobs
        - name: stalwart-config
          configMap:
            name: stalwart-config
        - name: fetchmail-config-template
          configMap:
            name: fetchmail-config
        - name: fetchmail-config
          emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: stalwart
  namespace: stalwart-mail
  labels:
    app: stalwart
spec:
  type: ClusterIP
  selector:
    app: stalwart
  ports:
    - name: smtp
      port: 25
      targetPort: 25
      protocol: TCP
    - name: submission
      port: 587
      targetPort: 587
      protocol: TCP
    - name: imaps
      port: 993
      targetPort: 993
      protocol: TCP
    - name: imap
      port: 143
      targetPort: 143
      protocol: TCP
    - name: http
      port: 80
      targetPort: 8080
      protocol: TCP

