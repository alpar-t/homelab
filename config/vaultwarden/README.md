# Vaultwarden

Self-hosted Bitwarden-compatible password manager with PostgreSQL backend.

## Components

| Component | Description |
|-----------|-------------|
| PostgreSQL | CloudNativePG cluster for database storage |
| Vaultwarden | Password manager server |
| Ingress | HTTPS access via `vault.newjoy.ro` |

## Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                         Ingress                                  │
│                    vault.newjoy.ro                              │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Vaultwarden                                 │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │   Web UI + REST API + WebSocket (unified port :80)       │   │
│  │   Note: Since v1.29, WebSocket is on the same port       │   │
│  └──────────────────────────────────────────────────────────┘   │
│                              │                                   │
│                              ▼                                   │
│                    ┌──────────────┐                             │
│                    │  PostgreSQL  │                             │
│                    │  (CNPG)      │                             │
│                    └──────────────┘                             │
│                                                                  │
│  Volumes:                                                        │
│  - /data (attachments, sends, RSA keys, icon cache)            │
└─────────────────────────────────────────────────────────────────┘
```

## Admin Panel

**The admin panel (`/admin`) is DISABLED** for security and simplicity.

All configuration is done via environment variables in the deployment manifest (GitOps-friendly).

### Why disable the admin panel?

1. **Reduced attack surface** - no admin endpoint to protect
2. **GitOps-friendly** - all config is in version control
3. **No secrets to manage** - no admin token needed

### What you lose without admin panel:

- View/delete/disable users (use PostgreSQL directly if needed)
- Runtime config changes (edit deployment.yaml instead)

### Re-enabling the admin panel (if needed):

Add to deployment.yaml:
```yaml
- name: ADMIN_TOKEN
  valueFrom:
    secretKeyRef:
      name: vaultwarden-secrets
      key: admin_token
```

Then create the secret:
```bash
ADMIN_TOKEN=$(openssl rand -hex 32)
kubectl create secret generic vaultwarden-secrets \
  --namespace=vaultwarden \
  --from-literal=admin_token="$ADMIN_TOKEN"
echo "Admin token: $ADMIN_TOKEN"
```

## Inviting Users

Open signups are disabled, but you can invite users via email.

### Send an Invite

```bash
# Get a pod name
POD=$(kubectl get pod -n vaultwarden -l app=vaultwarden -o jsonpath='{.items[0].metadata.name}')

# Send invite email
kubectl exec -n vaultwarden $POD -- curl -s -X POST \
  http://localhost:80/api/users/invite \
  -H "Content-Type: application/json" \
  -d '{"email": "user@example.com"}'
```

The user will receive an email with a signup link that bypasses the `SIGNUPS_ALLOWED=false` restriction.

**Requirements:**
- SMTP must be configured and working
- `INVITATIONS_ALLOWED=true` (already set)

## Secrets

| Secret | Key | Description |
|--------|-----|-------------|
| `vaultwarden-db-app` | `uri`, `username`, `password` | PostgreSQL credentials (auto-generated by CNPG) |
| `vaultwarden-smtp` | `from_address` | SMTP sender address (manual creation required) |

## One-Time Setup: SMTP Secret

Create the SMTP configuration secret:

```bash
kubectl create secret generic vaultwarden-smtp \
  --namespace=vaultwarden \
  --from-literal=from_address="..."
```

## Migration from Docker Compose (MySQL)

**IMPORTANT**: Vaultwarden does NOT support automatic migration from MySQL to PostgreSQL.
You must create new accounts on the new server and sync your vault.

### Method 1: Sync from Local Client (Easiest)

Bitwarden clients keep an encrypted local copy of your vault. Just log into the new server and it syncs automatically.

1. **Deploy the new instance** (signups are enabled by default)

2. **Create account on the new server:**
   - Go to `https://vault.newjoy.ro`
   - Create account with the **same email and master password** as before

3. **Update your existing client:**
   - Open your Bitwarden browser extension/app
   - Go to Settings → Server URL → set to `https://vault.newjoy.ro`
   - Log in with your credentials
   - Your local vault will sync to the new server

4. **Disable signups** after all users have migrated:
   ```yaml
   # In deployment.yaml, change:
   - name: SIGNUPS_ALLOWED
     value: "false"
   ```

**Why this works:** Your vault is encrypted client-side with your master password. The encrypted data is stored locally. When you log into a new server, the client uploads your encrypted vault.

### Method 2: Export/Import (Alternative)

If the local sync doesn't work or you want a clean start:

1. **Export from old instance:**
   - Log into the old web vault
   - Go to **Tools → Export Vault**
   - Choose `.json` format
   - Save securely (contains plaintext passwords!)

2. **Create account on new server**

3. **Import to new instance:**
   - Go to **Tools → Import Data**
   - Select format: **Bitwarden (json)**
   - Upload the export file

4. **Delete the export file** (it contains unencrypted passwords!)

## Migrating Attachments

If users have attachments, you'll need to migrate them manually:

```bash
# Copy attachments from old instance
scp -r user@old-server:/srv/apps/vw-data/attachments /tmp/

# Copy into the new PVC
kubectl cp /tmp/attachments vaultwarden/<pod-name>:/data/attachments

# Fix permissions
kubectl exec -n vaultwarden <pod-name> -- chown -R 1000:1000 /data/attachments
```

## Post-Migration Checklist

- [ ] All users have created accounts on new server
- [ ] All vault items synced successfully
- [ ] Attachments migrated (see below)
- [ ] 2FA is working
- [ ] WebSocket sync working (test real-time updates between devices)
- [ ] Email notifications working (test password reset)
- [ ] **Set `SIGNUPS_ALLOWED=false`** after all users registered
- [ ] Update DNS/Cloudflare tunnel for new domain

## Updating Clients

All Bitwarden clients need to be reconfigured:

### Browser Extension
1. Click the settings gear
2. Set **Server URL** to `https://vault.newjoy.ro`
3. Log in

### Mobile App
1. Tap settings before logging in
2. Set **Server URL** to `https://vault.newjoy.ro`
3. Log in

### Desktop App
1. Go to **Settings → Server URL**
2. Set to `https://vault.newjoy.ro`
3. Log in

### CLI
```bash
bw config server https://vault.newjoy.ro
bw login
```

## Troubleshooting

### Check logs
```bash
kubectl logs -n vaultwarden -l app=vaultwarden -f
```

### Check PostgreSQL connection
```bash
kubectl exec -n vaultwarden -it deploy/vaultwarden -- /bin/sh -c 'echo "SELECT 1;" | psql $DATABASE_URL'
```

### Restart the pod
```bash
kubectl rollout restart deployment/vaultwarden -n vaultwarden
```

### Access the database directly
```bash
# Get database credentials
kubectl get secret vaultwarden-db-app -n vaultwarden -o jsonpath='{.data.uri}' | base64 -d

# Connect to database pod
kubectl exec -n vaultwarden -it vaultwarden-db-1 -- psql -U vaultwarden -d vaultwarden
```

## Configuration Reference

| Environment Variable | Value | Description |
|---------------------|-------|-------------|
| `DATABASE_URL` | (from secret) | PostgreSQL connection string |
| `DOMAIN` | `https://vault.newjoy.ro` | External URL |
| `SIGNUPS_ALLOWED` | `true` | Set to `false` after migration |
| `INVITATIONS_ALLOWED` | `true` | Allow inviting users via email |
| `WEBSOCKET_ENABLED` | `true` | Real-time sync |
| `SMTP_FROM` | (from secret) | Email sender address |
| `SHOW_PASSWORD_HINT` | `false` | Hide password hints (security) |

## Resources

- [Vaultwarden Wiki](https://github.com/dani-garcia/vaultwarden/wiki)
- [CloudNativePG Documentation](https://cloudnative-pg.io/docs/)
- [Bitwarden Help Center](https://bitwarden.com/help/)
