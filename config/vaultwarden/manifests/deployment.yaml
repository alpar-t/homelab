# Vaultwarden Deployment
# Self-hosted Bitwarden-compatible password manager
#
# Uses PostgreSQL backend (CloudNativePG) instead of SQLite/MySQL
# All vault data is stored in PostgreSQL; PVC stores attachments, sends, and keys

apiVersion: apps/v1
kind: Deployment
metadata:
  name: vaultwarden
  namespace: vaultwarden
  labels:
    app: vaultwarden
  annotations:
    argocd.argoproj.io/sync-wave: "2"
spec:
  replicas: 1
  strategy:
    type: Recreate  # Required for RWO PVC
  selector:
    matchLabels:
      app: vaultwarden
  template:
    metadata:
      labels:
        app: vaultwarden
      annotations:
        # Auto-restart when secrets change (requires Reloader)
        secret.reloader.stakater.com/reload: "vaultwarden-db-app,vaultwarden-smtp"
    spec:
      initContainers:
        # Wait for PostgreSQL to be ready
        - name: wait-for-postgres
          image: busybox:1.36@sha256:6b219909078e3fc93b81f83cb438bd7a5457984a01a478c76fe9777a8c67c39e
          command:
            - 'sh'
            - '-c'
            - |
              until nc -z vaultwarden-db-rw.vaultwarden.svc.cluster.local 5432; do
                echo "Waiting for PostgreSQL..."
                sleep 2
              done
              echo "PostgreSQL is ready!"
      containers:
        - name: vaultwarden
          image: vaultwarden/server:1.32.7
          ports:
            - containerPort: 80
              name: http
          env:
            # ===================
            # Database Configuration (PostgreSQL)
            # ===================
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: vaultwarden-db-app
                  key: uri
            
            # ===================
            # Admin Panel - DISABLED
            # ===================
            # Not setting ADMIN_TOKEN disables /admin entirely
            # All config is done via environment variables (GitOps-friendly)
            # To re-enable, add ADMIN_TOKEN env var from a secret
            
            # ===================
            # Domain Configuration
            # ===================
            # Update this to your actual domain
            - name: DOMAIN
              value: "https://vault.newjoy.ro"
            
            # ===================
            # General Settings
            # ===================
            # Open signups - set to "false" after initial migration
            - name: SIGNUPS_ALLOWED
              value: "true"
            # Allow inviting users via email (requires SMTP)
            - name: INVITATIONS_ALLOWED
              value: "true"
            # WebSocket notifications for real-time sync
            - name: WEBSOCKET_ENABLED
              value: "true"
            # Show password hints (set to false for better security)
            - name: SHOW_PASSWORD_HINT
              value: "false"
            
            # ===================
            # SMTP Configuration
            # ===================
            # Uses Stalwart as local relay (cluster-internal, no auth needed)
            - name: SMTP_HOST
              value: "stalwart.stalwart-mail.svc.cluster.local"
            - name: SMTP_PORT
              value: "25"
            - name: SMTP_FROM
              valueFrom:
                secretKeyRef:
                  name: vaultwarden-smtp
                  key: from_address
            - name: SMTP_SECURITY
              value: "off"
            # Empty values for no auth
            - name: SMTP_USERNAME
              value: ""
            - name: SMTP_PASSWORD
              value: ""
            
            # ===================
            # Logging
            # ===================
            - name: LOG_LEVEL
              value: "info"
            - name: EXTENDED_LOGGING
              value: "true"
          
          volumeMounts:
            - name: data
              mountPath: /data
          
          resources:
            requests:
              cpu: 50m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 512Mi
          
          # Health checks
          startupProbe:
            httpGet:
              path: /alive
              port: http
            initialDelaySeconds: 5
            failureThreshold: 30
            periodSeconds: 5
          livenessProbe:
            httpGet:
              path: /alive
              port: http
            periodSeconds: 30
            timeoutSeconds: 5
          readinessProbe:
            httpGet:
              path: /alive
              port: http
            periodSeconds: 10
            timeoutSeconds: 5
      
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: vaultwarden-data
---
# ClusterIP service for web interface (accessed via Ingress)
apiVersion: v1
kind: Service
metadata:
  name: vaultwarden
  namespace: vaultwarden
  labels:
    app: vaultwarden
  annotations:
    argocd.argoproj.io/sync-wave: "2"
spec:
  type: ClusterIP
  selector:
    app: vaultwarden
  ports:
    - name: http
      port: 80
      targetPort: 80
      protocol: TCP
